@page "{guid:guid}"
@using Markdig
@model InventoryManagement.Pages.Inventory.DetailsModel

@{
    var inv = Model.Inventory;
    ViewData["Title"] = "Details";

    var allowedCount = (inv != null && !inv.IsPublic) ? (inv.AllowedUsers?.Count ?? 0) : 0;
    var usersLabel = allowedCount == 1 ? "user" : "users";
    var visibility = (inv?.IsPublic == true) ? "Public" : $"Private ({allowedCount} {usersLabel})";

    var createdAtUtc = inv?.CreatedAt.ToUniversalTime().ToString("o");
    var updatedAtUtc = inv?.UpdatedAt.ToUniversalTime().ToString("o");

    var ownerFullName = (inv?.Owner.FirstName ?? "") + " " + (inv?.Owner.LastName ?? "");

    var customFieldList = new List<(string Type, short? Position, string? Title, string? Description)>();
    if (inv != null)
    {
        void Add(string type, InventoryManagement.Models.Inventory.CustomField? f)
        {
            if (f != null && f.IsUsed) customFieldList.Add((type, f.Position, f.Title, f.Description));
        }

        Add("Single line", inv.SingleLine1);
        Add("Single line", inv.SingleLine2);
        Add("Single line", inv.SingleLine3);
        Add("Multi line", inv.MultiLine1);
        Add("Multi line", inv.MultiLine2);
        Add("Multi line", inv.MultiLine3);
        Add("Numeric", inv.NumericLine1);
        Add("Numeric", inv.NumericLine2);
        Add("Numeric", inv.NumericLine3);
        Add("Boolean", inv.BoolLine1);
        Add("Boolean", inv.BoolLine2);
        Add("Boolean", inv.BoolLine3);

        customFieldList = customFieldList.OrderBy(cf => cf.Position ?? short.MaxValue).ToList();
    }

    string PrettyElementName(string t) => t switch
    {
        "FixedText" => "Fixed Text",
        "Bit20" => "20-bit",
        "Bit32" => "32-bit",
        "Digit6" => "6 Character Digit",
        "Digit9" => "9 Character Digit",
        "Guid" => "GUID",
        "DateTime" => "Date/Time",
        "Sequential" => "Sequential",
        _ => t
    };

    var customIdElements = new List<dynamic>();
    if (inv?.CustomId?.Elements != null)
    {
        foreach (var e in inv.CustomId.Elements)
        {
            if (e == null) continue;
            var type = e.GetType().Name.Replace("Element", "");
            customIdElements.Add(new {
                Type = type,
                DisplayType = PrettyElementName(type),
                e.Position,
                e.SeparatorBefore,
                e.SeparatorAfter,
                Element = e
            });
        }
        customIdElements = customIdElements
            .OrderBy(e => (short?)(e.Position ?? short.MaxValue))
            .ThenBy(e => e.Type)
            .ToList();
    }

    bool isModerator = Model.CanModerate;
    bool isEditor = Model.CanEdit;
    bool forceItemsActive = Model.EditMode && isModerator && !isEditor;
}

<h1 class="mb-3">Details</h1>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center d-flex flex-column">
                @if (!string.IsNullOrWhiteSpace(inv?.ImageUrl))
                {
                    <img src="@inv.ImageUrl" alt="Image" class="img-fluid mb-3" style="max-height:260px; object-fit:contain;" />
                }
                else
                {
                    <div class="border rounded bg-body-secondary d-flex align-items-center justify-content-center mb-3" style="height:220px;">
                        <span class="text-body-secondary">No image</span>
                    </div>
                }

                <h5 class="card-title mb-1 text-truncate">@Html.DisplayFor(m => m.Inventory.Title)</h5>
                @if (!string.IsNullOrWhiteSpace(inv?.Category?.Name))
                {
                    <p class="card-text text-muted small mb-0">@inv.Category.Name</p>
                }
                <hr />
                <div class="card-text mt-2 text-break mb-3">@Html.Raw(Markdown.ToHtml(inv?.Description ?? ""))</div>

                @if (inv?.Tags != null && inv.Tags.Count > 0)
                {
                    <div class="d-flex flex-wrap gap-2 mb-3 justify-content-center">
                        @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                        {
                            <span class="badge rounded-pill bg-secondary px-3 py-2">@tag.Name</span>
                        }
                    </div>
                }

                <div class="mt-auto w-100 d-grid gap-2">
                    @if (!Model.EditMode)
                    {
                        @if (User?.Identity?.IsAuthenticated == true && (isEditor || isModerator))
                        {
                            <a asp-page="../Items/Create" asp-route-guid="@inv?.Guid" class="btn btn-primary btn-sm w-100">Create Item</a>
                        }
                        <a asp-page="./Index" class="btn btn-secondary btn-sm w-100">Back to list</a>
                    }
                    @if ((isEditor || isModerator) && !Model.EditMode)
                    {
                        <form method="get" class="d-inline">
                            <input type="hidden" name="guid" value="@inv.Guid" />
                            <input type="hidden" name="EditMode" value="true" />
                            <button type="submit" class="btn btn-outline-primary btn-sm w-100">Edit</button>
                        </form>
                    }
                    @if (Model.EditMode)
                    {
                        @if (isEditor)
                        {
                            <form method="post" asp-page-handler="Edit" id="editForm" class="d-inline" enctype="multipart/form-data">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="guid" value="@inv.Guid" />
                                <input type="hidden" id="editVersion" name="Edit.Version" value="@Model.Edit.Version" />
                                <button type="submit" id="saveButton" class="btn btn-primary btn-sm w-100">Save</button>
                                <div id="autosaveStatus" class="text-muted small mt-1 text-start" aria-live="polite"></div>
                            </form>
                        }
                        <form method="get" class="d-inline">
                            <input type="hidden" name="guid" value="@inv.Guid" />
                            <input type="hidden" name="EditMode" value="false" />
                            <button type="submit" class="btn btn-outline-secondary btn-sm w-100">Cancel</button>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(forceItemsActive ? null : "active")" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" @(Model.EditMode && isModerator && !isEditor ? "disabled" : null)>Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visibility-tab" data-bs-toggle="tab" data-bs-target="#visibility" type="button" role="tab" @(Model.EditMode && isModerator && !isEditor ? "disabled" : null)>Access Level</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-fields-tab" data-bs-toggle="tab" data-bs-target="#custom-fields" type="button" role="tab" @(Model.EditMode && isModerator && !isEditor ? "disabled" : null)>Custom Fields</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(forceItemsActive ? "active" : null)" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">Items</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-id-tab" data-bs-toggle="tab" data-bs-target="#custom-id" type="button" role="tab" @(Model.EditMode && isModerator && !isEditor ? "disabled" : null)>Custom ID</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags" type="button" role="tab" @(Model.EditMode && isModerator && !isEditor ? "disabled" : null)>Tags</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab">Discussion</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button" role="tab">Statistics</button>
            </li>
        </ul>
        <div class="tab-content border border-top-0 p-3" id="detailTabsContent">
            <div class="tab-pane fade @(forceItemsActive ? null : "show active")" id="info" role="tabpanel" aria-labelledby="info-tab">
                @if (Model.EditMode && isEditor)
                {
                    <h4 class="mb-2">Edit general info</h4>
                    <hr />
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="Edit.Title"></label>
                        <input class="form-control" asp-for="Edit.Title" id="editTitle" form="editForm" />
                        <span asp-validation-for="Edit.Title" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="Edit.Description"></label>
                        <textarea class="form-control" asp-for="Edit.Description" id="editDescription" rows="6" form="editForm"></textarea>
                        <span asp-validation-for="Edit.Description" class="text-danger"></span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" asp-for="Edit.CategoryId"></label>
                            <select asp-for="Edit.CategoryId" class="form-select" id="editCategory" asp-items="Model.Categories" form="editForm">
                                <option value="">-- Select --</option>
                            </select>
                            <span asp-validation-for="Edit.CategoryId" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" asp-for="Edit.Image"></label>
                            <input class="form-control" asp-for="Edit.Image" id="editImage" accept="image/*" form="editForm" />
                            <div class="form-text">Leave empty to keep the current image.</div>
                            <span asp-validation-for="Edit.Image" class="text-danger"></span>
                        </div>
                    </div>
                }
                else
                {
                    <h4 class="mb-2">Inventory</h4>
                    <hr />
                    <dl class="row">
                        @if (inv?.Guid != null)
                        {
                            <dt class="col-sm-3">Identifier</dt>
                            <dd class="col-sm-9">
                                <div class="text-monospace small text-break">@inv.Guid.ToString()</div>
                            </dd>
                        }

                        @if (!string.IsNullOrWhiteSpace(inv?.Category?.Name))
                        {
                            <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.Category)</dt>
                            <dd class="col-sm-9">@inv.Category.Name</dd>
                        }

                        @if (inv?.Owner != null)
                        {
                            <dt class="col-sm-3">Owner</dt>
                            <dd class="col-sm-9">
                                <a asp-page="/Users/Details" asp-route-id="@inv.Owner.Id">@ownerFullName (@inv.Owner.Email)</a>
                            </dd>
                        }

                        <dt class="col-sm-3">Access Level</dt>
                        <dd class="col-sm-9">@visibility</dd>

                        @if (inv?.Tags != null && inv.Tags.Count > 0)
                        {
                            <dt class="col-sm-3">Tags</dt>
                            <dd class="col-sm-9">
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                                    {
                                        <span class="badge rounded-pill bg-secondary px-3 py-2">@tag.Name</span>
                                    }
                                </div>
                            </dd>
                        }

                        @if (!string.IsNullOrWhiteSpace(createdAtUtc))
                        {
                            <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.CreatedAt)</dt>
                            <dd class="col-sm-9" data-utc="@createdAtUtc">@DateTime.Parse(createdAtUtc).ToString("MMMM d, yyyy")</dd>
                        }

                        @if (!string.IsNullOrWhiteSpace(updatedAtUtc))
                        {
                            <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.UpdatedAt)</dt>
                            <dd class="col-sm-9" data-utc="@updatedAtUtc">@DateTime.Parse(updatedAtUtc).ToString("MMMM d, yyyy")</dd>
                        }
                    </dl>
                }
            </div>

            <div class="tab-pane fade" id="visibility" role="tabpanel" aria-labelledby="visibility-tab">
                <h5 class="mb-3">Access Level</h5>
                <dl class="row">
                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">@visibility</dd>
                </dl>

                @if (Model.EditMode && isEditor)
                {
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" asp-for="Edit.IsPublic" role="switch" id="editIsPublic" form="editForm" />
                        <label class="form-check-label" for="editIsPublic">Public</label>
                    </div>
                    <div id="allowedUsersSection" class="mt-2" style="display:none;">
                        <div class="form-text">Type a name to find users and add them. Visible only when inventory is not public.</div>
                        <div class="position-relative">
                            <input type="text" id="userSearch" class="form-control" placeholder="Search users..." autocomplete="off" />
                            <div id="userSuggestions" class="list-group position-absolute w-100" style="z-index: 1050; display:none; max-height: 220px; overflow:auto;"></div>
                        </div>
                        <div id="selectedUsers" class="d-flex flex-wrap gap-2 mt-2"></div>
                        <div id="userIdsContainer" class="d-none">
                            <input type="hidden" name="Edit.UserIds" data-template="user-id" form="editForm" />
                        </div>
                    </div>
                }
                else if (inv?.IsPublic != true)
                {
                    <h6 class="mt-3">Allowed users</h6>
                    @if (inv?.AllowedUsers != null && inv.AllowedUsers.Count > 0)
                    {
                        <ul class="list-group mt-2">
                            @foreach (var u in inv.AllowedUsers.OrderBy(u => u.FirstName).ThenBy(u => u.LastName).ThenBy(u => u.UserName))
                            {
                                var fullName = ($"{u.FirstName} {u.LastName}").Trim();
                                var display = string.IsNullOrWhiteSpace(fullName) ? u.UserName : fullName;
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <a asp-page="/Users/Details" asp-route-id="@u.Id" class="fw-semibold">@display</a>
                                        @if (!string.IsNullOrWhiteSpace(u.Email))
                                        {
                                            <span class="text-muted"> (@u.Email)</span>
                                        }
                                    </span>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted">No users explicitly allowed.</div>
                    }
                }
            </div>

            <div class="tab-pane fade" id="custom-fields" role="tabpanel" aria-labelledby="custom-fields-tab">
                @if (Model.EditMode && isEditor)
                {
                    <h5 class="mb-3">Edit custom fields</h5>
                    <partial name="~/Pages/Inventory/Partials/_EditCustomFields.cshtml" model="Model" />
                }
                else
                {
                    @if (customFieldList.Count > 0)
                    {
                        <h5 class="mb-3">Custom fields</h5>
                        <div class="d-grid gap-3">
                            @for (int i = 0; i < customFieldList.Count; i++)
                            {
                                var cf = customFieldList[i];
                                var index = i + 1;
                                var title = string.IsNullOrWhiteSpace(cf.Title) ? "(no title)" : cf.Title;
                                var desc = string.IsNullOrWhiteSpace(cf.Description) ? "(no description)" : cf.Description;

                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-secondary">@index</span>
                                                <h6 class="mb-0">@title</h6>
                                            </div>
                                            <small class="text-muted">@cf.Type</small>
                                        </div>
                                        <div class="card-text">@desc</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">No custom fields configured.</div>
                    }
                }
            </div>

            <div class="tab-pane fade @(forceItemsActive ? "show active" : null)" id="items" role="tabpanel" aria-labelledby="items-tab">
                <h5 class="mb-3">Items</h5>
                @if (Model.EditMode && isModerator)
                {
                    <div class="alert alert-warning py-2 small" role="alert">
                        Deleting items is permanent and cannot be undone, even if you cancel editing.
                    </div>
                }
                @if (inv?.Items != null && inv.Items.Count > 0)
                {
                    @await Html.PartialAsync("~/Pages/Shared/_ItemsTable.cshtml", new InventoryManagement.Models.ViewModels.ItemsTableModel
                    {
                        Items = inv.Items,
                        ShowInventoryColumn = false,
                        EnableSelection = Model.EditMode && isModerator,
                        DeleteUrl = Url.Page(null, "DeleteItems", new { guid = inv.Guid })
                    })
                }
                else
                {
                    <div class="text-muted">No items found for this inventory.</div>
                }
            </div>

            <div class="tab-pane fade" id="custom-id" role="tabpanel" aria-labelledby="custom-id-tab">
                @if (Model.EditMode && isEditor)
                {
                    <h5 class="mb-3">Edit Custom ID</h5>
                    <partial name="~/Pages/Inventory/Partials/_EditCustomId.cshtml" model="Model" />
                }
                else
                {
                    <h5 class="mb-3">Custom ID structure</h5>
                    @if (customIdElements.Count > 0)
                    {
                        <div class="d-grid gap-3">
                            @{ var idx = 1; }
                            @foreach (var ce in customIdElements)
                            {
                                var element = ce.Element;
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-secondary">@idx</span>
                                                <h6 class="mb-0">@ce.DisplayType</h6>
                                            </div>
                                        </div>
                                        <dl class="row mb-0">
                                            @if (ce.SeparatorBefore != null)
                                            {
                                                <dt class="col-sm-3">Separator before</dt>
                                                <dd class="col-sm-9">@ce.SeparatorBefore.ToString()</dd>
                                            }
                                            @if (ce.SeparatorAfter != null)
                                            {
                                                <dt class="col-sm-3">Separator after</dt>
                                                <dd class="col-sm-9">@ce.SeparatorAfter.ToString()</dd>
                                            }

                                            @if (element is InventoryManagement.Models.Inventory.CustomId.Element.AbstractNumericElement num && element is not InventoryManagement.Models.Inventory.CustomId.Element.SequentialElement)
                                            {
                                                <dt class="col-sm-3">Radix</dt>
                                                <dd class="col-sm-9">@num.Radix</dd>
                                                @if (num.PaddingChar.HasValue)
                                                {
                                                    <dt class="col-sm-3">Padding</dt>
                                                    <dd class="col-sm-9">@num.PaddingChar.ToString()</dd>
                                                }
                                            }
                                            else if (element is InventoryManagement.Models.Inventory.CustomId.Element.DateTimeElement dt)
                                            {
                                                @if (!string.IsNullOrEmpty(dt.DateTimeFormat))
                                                {
                                                    <dt class="col-sm-3">Format</dt>
                                                    <dd class="col-sm-9">@dt.DateTimeFormat</dd>
                                                }
                                            }
                                            else if (element is InventoryManagement.Models.Inventory.CustomId.Element.FixedTextElement ft)
                                            {
                                                @if (!string.IsNullOrEmpty(ft.FixedText))
                                                {
                                                    <dt class="col-sm-3">Text</dt>
                                                    <dd class="col-sm-9">@ft.FixedText</dd>
                                                }
                                            }
                                        </dl>
                                    </div>
                                </div>
                                idx++;
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">No Custom ID configured for this inventory.</div>
                    }
                }
            </div>

            <div class="tab-pane fade" id="tags" role="tabpanel" aria-labelledby="tags-tab">
                <h5 class="mb-3">Tags</h5>
                @if (inv?.Tags != null && inv.Tags.Count > 0)
                {
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                        {
                            <span class="badge rounded-pill bg-secondary px-3 py-2 d-inline-flex align-items-center gap-2" data-tag="@tag.Name">
                                @tag.Name
                                @if (Model.EditMode && isEditor)
                                {
                                    <button type="button" class="btn-close btn-close-white btn-sm" aria-label="Remove" data-remove-tag="@tag.Name"></button>
                                }
                            </span>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted mb-3">No tags for this inventory.</div>
                }

                @if (User?.Identity?.IsAuthenticated == true)
                {
                    <form method="post" asp-page-handler="AddTag" class="d-flex gap-2 align-items-start position-relative">
                        <input type="hidden" name="guid" value="@inv.Guid" />
                        <div class="flex-grow-1">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="newTag" name="tag" placeholder="Add a tag" autocomplete="off" />
                                <label for="newTag">Add tag</label>
                            </div>
                            <div id="tagSuggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none; max-height:220px; overflow:auto;"></div>
                        </div>
                        <button class="btn btn-primary" type="submit">Add</button>
                    </form>
                }
                else
                {
                    <div class="text-muted small">Sign in to add tags.</div>
                }
            </div>

            <div class="tab-pane fade" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                @if (User?.Identity?.IsAuthenticated == true)
                {
                    <div class="mb-2">
                        <form id="postForm">
                            @Html.AntiForgeryToken()
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Write a comment in Markdown..." id="postContent" style="height:120px"></textarea>
                                <label for="postContent">New post</label>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                @if (Model.EditMode && isModerator)
                                {
                                    <div id="discussionBulkBar" class="gap-2 align-items-center">
                                        <button type="button" id="selectAllPosts" class="btn btn-sm btn-outline-secondary">Select all</button>
                                        <button type="button" id="deselectAllPosts" class="btn btn-sm btn-outline-secondary">Deselect</button>
                                        <button type="button" id="deleteSelectedPosts" class="btn btn-sm btn-danger">Delete selected</button>
                                    </div>
                                }
                                <button type="submit" class="btn btn-primary btn-sm">Post</button>
                            </div>
                        </form>
                        @if (Model.EditMode && isModerator)
                        {
                            <div class="alert alert-warning py-2 small mt-2" role="alert">
                                Deleting discussion posts is permanent and cannot be undone, even if you cancel editing.
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted">Sign in to participate in the discussion.</div>
                }
                <hr />
                <div id="posts" class="d-grid gap-3"></div>
            </div>

            <div class="tab-pane fade" id="insights" role="tabpanel" aria-labelledby="insights-tab">
                <h5 class="mb-3">Statistics</h5>
                <div id="insightsContent" class="text-muted">Click the tab to load statistics.</div>
            </div>
        </div>
        @if (!Model.EditMode)
        {
            <div class="mt-3">
                <a asp-page="./Index" class="btn btn-secondary btn-sm">Back to list</a>
            </div>
        }
    </div>
</div>

@section Scripts {
<partial name="~/Pages/Shared/_ValidationScriptsPartial.cshtml" />
<script>
(() => {
  const invGuid = '@inv?.Guid';
  if (!invGuid) return;
  const postsEl = document.getElementById('posts');
  const form = document.getElementById('postForm');
  const contentEl = document.getElementById('postContent');
  const afEl = document.querySelector('#postForm input[name="__RequestVerificationToken"]');
  let lastId = 0;
  const canManageDiscussion = @((Model.EditMode && Model.CanModerate) ? "true" : "false");

  const tabsRoot = document.getElementById('detailTabs');
  function activateFromHash() {
    const hash = window.location.hash;
    if (!hash) return;
    const trigger = tabsRoot?.querySelector(`[data-bs-target="${hash}"]`);
    if (trigger && window.bootstrap && bootstrap.Tab) {
      new bootstrap.Tab(trigger).show();
    }
  }
  tabsRoot?.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', (e) => {
      const target = e.target?.getAttribute('data-bs-target');
      if (target) {
        history.replaceState(null, '', target);
      }
    });
  });
  if (window.location.hash) {
    activateFromHash();
  }
  window.addEventListener('hashchange', activateFromHash);

  const bulkBar = document.getElementById('discussionBulkBar');
  const btnSelectAll = document.getElementById('selectAllPosts');
  const btnDeselectAll = document.getElementById('deselectAllPosts');
  const btnDeleteSelected = document.getElementById('deleteSelectedPosts');
  const selected = new Set();

  function updateBulkBar(){
    if (!canManageDiscussion) { bulkBar?.classList.add('d-none'); return; }
    const any = postsEl.querySelector('.post-select');
    if (!any) { bulkBar?.classList.add('d-none'); return; }
    bulkBar?.classList.remove('d-none');
    if (btnDeleteSelected) btnDeleteSelected.disabled = selected.size === 0;
  }

  function userDisplay(u){
    const name = ([(u.firstName||''),(u.lastName||'')].join(' ').trim()) || (u.userName||'(user)');
    return name;
  }

  function postCheckbox(id){
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.className = 'form-check-input me-2 post-select';
    input.addEventListener('change', () => {
      if (input.checked) selected.add(id); else selected.delete(id);
      updateBulkBar();
    });
    return input;
  }

  function renderPost(p) {
    const wrapper = document.createElement('div');
    wrapper.className = 'card';
    wrapper.dataset.postId = String(p.id);
    wrapper.innerHTML = `
      <div class="card-body">\n        <div class="d-flex justify-content-between align-items-start mb-2">\n          <div>\n            <a href="/Users/Details?id=${encodeURIComponent(p.user.id)}">${userDisplay(p.user)}</a>\n            <div class="text-muted small">${new Date(p.createdAtUtc + 'Z').toLocaleString()}</div>\n          </div>\n        </div>\n        <div class="markdown">${p.html}</div>\n      </div>` ;
    const head = wrapper.querySelector('.card-body > .d-flex');
    if (canManageDiscussion) {
      const cb = postCheckbox(p.id);
      const holder = document.createElement('div');
      holder.className = 'form-check';
      holder.appendChild(cb);
      head.prepend(holder);
    }
    postsEl.appendChild(wrapper);
  }

  btnSelectAll?.addEventListener('click', () => {
    postsEl.querySelectorAll('.post-select').forEach(cb => { cb.checked = true; selected.add(parseInt(cb.closest('.card').dataset.postId)); });
    updateBulkBar();
  });
  btnDeselectAll?.addEventListener('click', () => {
    postsEl.querySelectorAll('.post-select').forEach(cb => { cb.checked = false; });
    selected.clear();
    updateBulkBar();
  });
  btnDeleteSelected?.addEventListener('click', async () => {
    if (selected.size === 0) return;
    try {
      const token = afEl?.value || '';
      const res = await fetch(`${window.location.pathname}?handler=DeleteDiscussion&guid=${encodeURIComponent(invGuid)}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'RequestVerificationToken': token,
          'X-RequestVerificationToken': token
        },
        credentials: 'same-origin',
        body: JSON.stringify({ ids: Array.from(selected) })
      });
      if (!res.ok) return;
      const data = await res.json();
      const ids = Array.isArray(data.deletedIds) ? data.deletedIds : [];
      ids.forEach(id => {
        const card = postsEl.querySelector(`.card[data-post-id="${id}"]`);
        if (card) card.remove();
        selected.delete(id);
      });
      updateBulkBar();
    } catch {}
  });

  async function fetchNew() {
    try {
      const url = new URL(`${window.location.pathname}?handler=Discussion`, window.location.origin);
      if (lastId > 0) url.searchParams.set('afterId', String(lastId));
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      if (Array.isArray(data)) {
        for (const p of data) {
          renderPost(p);
          lastId = Math.max(lastId, p.id);
        }
        updateBulkBar();
      }
    } catch {}
  }

  async function initLoad(){
    lastId = 0;
    postsEl.innerHTML = '';
    selected.clear();
    await fetchNew();
    setInterval(fetchNew, 3000);
  }

  document.getElementById('discussion-tab')?.addEventListener('shown.bs.tab', initLoad, { once: true });
  if (window.location.hash === '#discussion') {
    initLoad();
  }

  // Statistics: fetch on tab click and render
  (function(){
    const tab = document.getElementById('insights-tab');
    const container = document.getElementById('insightsContent');
    let loaded = false;

    function renderInsights(ag){
      if (!ag){ container.textContent = 'No items to analyze.'; return; }
      const parts = [];
      parts.push(`<div class="row g-3 mb-2">`
        + cardMetric('Items', ag.totalItems)
        + cardMetric('Avg likes', (ag.averageLikesPerItem||0).toFixed(2))
        + cardMetric('Max likes', ag.maxLikesPerItem)
        + `</div>`);
      parts.push(`<div class="row g-3 mb-4">`
        + cardMetric('Global: public inventories', `${(ag.globalPercentPublicInventories||0).toFixed(2)}%`, 6)
        + cardMetric('Global: avg allowed for private', (ag.globalAvgAllowedUsersForPrivateInventories||0).toFixed(2), 6)
        + `</div>`);

      if (ag.numeric && Object.keys(ag.numeric).length){
        parts.push('<h6 class="mt-3">Numeric fields</h6>');
        parts.push('<div class="row g-3">');
        for (const [label, s] of Object.entries(ag.numeric)){
          parts.push(`<div class="col-md-6"><div class="card h-100"><div class="card-body">`
            + `<div class="d-flex justify-content-between align-items-start"><span class="fw-semibold">${escapeHtml(label)}</span><span class="badge text-bg-light">${s.count} values</span></div>`
            + `<div class="mt-2 small"><div>Average: <span class="fw-semibold">${fmtNum(s.average)}</span></div><div>Range: <span class="fw-semibold">${fmtNum(s.min)}</span> – <span class="fw-semibold">${fmtNum(s.max)}</span></div></div>`
            + `</div></div></div>`);
        }
        parts.push('</div>');
      }

      if (ag.text && Object.keys(ag.text).length){
        parts.push('<h6 class="mt-4">Text fields (top values)</h6>');
        for (const [label, s] of Object.entries(ag.text)){
          parts.push('<div class="card"><div class="card-body">' 

            + `<div class="d-flex justify-content-between align-items-start"><span class="fw-semibold">${escapeHtml(label)}</span><span class="badge text-bg-light">${s.count} total</span></div>`);
          if (Array.isArray(s.top) && s.top.length){
            parts.push('<ul class="mt-2 mb-0 small">');
            for (const v of s.top){
              parts.push(`<li>${escapeHtml(String(v.value))} (<span class="fw-semibold">${v.count}</span>)</li>`);
            }
            parts.push('</ul>');
          } else {
            parts.push('<div class="text-muted small mt-2">No values.</div>');
          }
          parts.push('</div></div>');
        }
      }

      if (ag.bool && Object.keys(ag.bool).length){
        parts.push('<h6 class="mt-4">Boolean fields</h6>');
        parts.push('<div class="row g-3">');
        for (const [label, s] of Object.entries(ag.bool)){
          parts.push(`<div class="col-md-6"><div class="card h-100"><div class="card-body">`
            + `<div class="fw-semibold">${escapeHtml(label)}</div>`
            + `<div class="mt-2 small"><div>True: <span class="fw-semibold">${s.trueCount}</span></div><div>False: <span class="fw-semibold">${s.falseCount}</span></div><div>Empty: <span class="fw-semibold">${s.nullCount}</span></div></div>`
            + `</div></div></div>`);
        }
        parts.push('</div>');
      }

      container.innerHTML = parts.join('');
    }

    function fmtNum(v){ return (v===null || v===undefined) ? '' : Number(v).toFixed(3).replace(/\.0+$/,''); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function cardMetric(label, value, col=4){
      const colClass = col===6 ? 'col-sm-6 col-md-6' : 'col-sm-6 col-md-4';
      return `<div class="${colClass}"><div class="card h-100"><div class="card-body"><div class="text-muted small">${escapeHtml(label)}</div><div class="display-6">${escapeHtml(String(value))}</div></div></div></div>`;
    }

    async function loadInsights(){
      if (loaded) return; // only load once per page view
      loaded = true;
      container.textContent = 'Loading...';
      try {
        const url = new URL(`${window.location.pathname}?handler=Insights&guid=${encodeURIComponent(invGuid)}`, window.location.origin);
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok){ container.textContent = 'Failed to load statistics.'; return; }
        const data = await res.json();
        renderInsights(data);
      } catch {
        container.textContent = 'Failed to load statistics.';
      }
    }

    document.getElementById('insights-tab')?.addEventListener('shown.bs.tab', loadInsights, { once: true });
    if (window.location.hash === '#insights') { loadInsights(); }
  })();

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = contentEl.value.trim();
      if (!content) return;
      const headers = { 'Content-Type': 'application/json' };
      const token = afEl?.value;
      if (token) {
        headers['RequestVerificationToken'] = token;
        headers['X-RequestVerificationToken'] = token;
      }
      const res = await fetch(`${window.location.pathname}?handler=Discussion`, {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        contentEl.value = '';
        await fetchNew();
      }
    });
  }

  (function(){
    if (!@Model.EditMode.ToString().ToLower() || !@Model.CanEdit.ToString().ToLower()) return;
    const tagContainer = document.getElementById('detailTabsContent');
    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    tagContainer.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-remove-tag]');
      if (!btn) return;
      const name = btn.getAttribute('data-remove-tag');
      if (!name) return;
      try {
        const res = await fetch(`${window.location.pathname}?handler=RemoveTag&guid=${encodeURIComponent(invGuid)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token, 'X-RequestVerificationToken': token },
          credentials: 'same-origin',
          body: JSON.stringify({ tag: name })
        });
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.removed) {
          document.querySelectorAll(`[data-tag="${CSS.escape(name)}"]`).forEach(el => el.remove());
        }
      } catch {}
    });
  })();

  (function(){
    const isPublicEl = document.getElementById('editIsPublic');
    const section = document.getElementById('allowedUsersSection');
    const searchInput = document.getElementById('userSearch');
    const suggestions = document.getElementById('userSuggestions');
    const selectedUsers = document.getElementById('selectedUsers');
    const userIdsContainer = document.getElementById('userIdsContainer');
    const template = userIdsContainer ? userIdsContainer.querySelector('input[data-template="user-id"]') : null;

    if (!searchInput || !section) return;

    const selectedMap = new Map();

    function toggleSection(){
      if (!isPublicEl) return;
      section.style.display = isPublicEl.checked ? 'none' : '';
    }
    isPublicEl?.addEventListener('change', toggleSection);
    toggleSection();

    function clearSuggestions(){
      suggestions.innerHTML = '';
      suggestions.style.display = 'none';
    }

    function addUser(id, display){
      if (!id || selectedMap.has(id)) return;
      selectedMap.set(id, display);
      const chip = document.createElement('span');
      chip.className = 'badge rounded-pill text-bg-secondary d-inline-flex align-items-center gap-1 px-2 py-2';
      chip.dataset.userId = id;
      chip.textContent = display || id;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn-close btn-close-white btn-sm ms-1';
      btn.ariaLabel = 'Remove';
      btn.addEventListener('click', () => removeUser(id));
      chip.appendChild(btn);
      selectedUsers.appendChild(chip);

      if (template && userIdsContainer){
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = template.getAttribute('name');
        hidden.value = id;
        hidden.dataset.userId = id;
        hidden.setAttribute('form', 'editForm');
        userIdsContainer.appendChild(hidden);
      }
      document.dispatchEvent(new CustomEvent('edit-changed', { detail: { group: 'visibility' } }));
    }

    function removeUser(id){
      if (!selectedMap.has(id)) return;
      selectedMap.delete(id);
      const chip = selectedUsers.querySelector(`[data-user-id="${id}"]`);
      if (chip) chip.remove();
      const hidden = userIdsContainer.querySelector(`input[type="hidden"][data-user-id="${id}"]`);
      if (hidden) hidden.remove();
      document.dispatchEvent(new CustomEvent('edit-changed', { detail: 'visibility' }));
    }

    function renderSuggestion(item){
      const id = item.guid;
      const first = item.firstName || '';
      const last = item.LastName || '';
      const email = item.email || '';
      const full = (first + ' ' + last).trim();
      const display = (full || item.userName || id) + (email ? ` (${email})` : '' );
      const a = document.createElement('button');
      a.type = 'button';
      a.className = 'list-group-item list-group-item-action';
      a.textContent = display;
      a.addEventListener('click', () => {
        addUser(id, display);
        clearSuggestions();
        searchInput.value = '';
        searchInput.focus();
      });
      return a;
    }

    let debounceTimer = null;
    let abortCtrl = null;
    function search(q){
      if (abortCtrl) abortCtrl.abort();
      if (!q){ clearSuggestions(); return; }
      abortCtrl = new AbortController();
      fetch(`/api/search/users?query=${encodeURIComponent(q)}`, { signal: abortCtrl.signal })
        .then(r => r.ok ? r.json() : [])
        .then(items => {
          if (!Array.isArray(items)) { clearSuggestions(); return; }
          suggestions.innerHTML = '';
          items.filter item => !(selectedMap.has(item.guid)))
               .forEach(item => suggestions.appendChild(renderSuggestion(item)));
          suggestions.style.display = suggestions.childElementCount > 0 ? 'block' : 'none';
        })
        .catch(() => { clearSuggestions(); });
    }

    searchInput.addEventListener('input', () => {
      window.clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(() => search(searchInput.value), 200);
    });
    document.addEventListener('click', (e) => {
      if (!suggestions.contains(e.target) && e.target !== searchInput){
        clearSuggestions();
      }
    });

    try {
      const preset = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Edit.UserIds ?? new List<string>()));
      const arr = Array.isArray(preset) ? preset : [];
      arr.forEach id => addUser(id, id));
    } catch {}
  })();

  (function(){
    const newTagInput = document.getElementById('newTag');
    const tagList = document.getElementById('tagSuggestions');
    function clearTagList(){ tagList.innerHTML=''; tagList.style.display='none'; }
    function renderTagItem(name){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = name;
      btn.addEventListener('click', () => { newTagInput.value = name; clearTagList(); newTagInput.focus(); });
      return btn;
    }
    function renderNoResults(){
      const div = document.createElement('div');
      div.className = 'list-group-item text-muted';
      div.textContent = 'No tags found';
      return div;
    }
    function searchTags(q){
      const term = (q||'').trim();
      if (!term){ clearTagList(); return; }
      fetch(`/api/search/tags?query=${encodeURIComponent(term)}`)
        .then(r => r.ok ? r.json() : [])
        .then(items => {
          if (!Array.isArray(items)) { clearTagList(); return; }
          tagList.innerHTML = '';
          if (items.length === 0) tagList.appendChild(renderNoResults());
          else items.forEach(x => tagList.appendChild(renderTagItem(x.name)));
          tagList.style.display = 'block';
        })
        .catch(() => clearTagList());
    }
    newTagInput?.addEventListener('input', () => searchTags(newTagInput.value));
    document.addEventListener('click', (e) => {
      if (!(tagList.contains(e.target) || e.target === newTagInput)) clearTagList();
    });
  })();

  (function(){
    if (!@Model.EditMode.ToString().ToLower() || !@Model.CanEdit.ToString().ToLower()) return;

    const saveBtn = document.getElementById('saveButton');
    const statusEl = document.getElementById('autosaveStatus');
    const editForm = document.getElementById('editForm');
    const token = editForm?.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    const versionEl = document.getElementById('editVersion');

    const countdownSeconds = 10;
    let timerId = null;
    let tickId = null;
    let secondsLeft = countdownSeconds;
    const changedGroups = new Set();

    function setBtnCountdownText(){
      if (!saveBtn) return;
      saveBtn.textContent = `Saving in ${secondsLeft} seconds`;
    }
    function resetBtnText(){ if (saveBtn) saveBtn.textContent = 'Save'; }

    function schedule(){
      clearTimeout(timerId); clearInterval(tickId);
      secondsLeft = countdownSeconds;
      setBtnCountdownText();
      tickId = setInterval(() => {
        secondsLeft -= 1;
        if (secondsLeft <= 0){ clearInterval(tickId); }
        setBtnCountdownText();
      }, 1000);
      timerId = setTimeout(async () => { await autosave(); }, countdownSeconds * 1000);
    }

    function collectGeneral(){
      return {
        Title: document.getElementById('editTitle')?.value || '',
        Description: document.getElementById('editDescription')?.value || '',
        CategoryId: (() => { const v = document.getElementById('editCategory')?.value; return v ? parseInt(v) : null; })()
      };
    }
    function collectVisibility(){
      const isPublic = !!document.getElementById('editIsPublic')?.checked;
      const ids = Array.from(document.querySelectorAll('#userIdsContainer input[type="hidden"][name="Edit.UserIds"]')).map(i => i.value);
      return { IsPublic: isPublic, UserIds: ids };
    }
    function collectCustomFields(){
      function read(prefix){
        const obj = {};
        obj.Title = document.querySelector(`[name="Edit.${prefix}.Title"]`)?.value || '';
        obj.Description = document.querySelector(`[name="Edit.${prefix}.Description"]`)?.value || '';
        const isUsedVal = document.querySelector(`[name="Edit.${prefix}.IsUsed"]`)?.value;
        obj.IsUsed = (isUsedVal === 'true' || isUsedVal === 'True');
        const posVal = document.querySelector(`[name="Edit.${prefix}.Position"]`)?.value;
        obj.Position = posVal ? parseInt(posVal) : null;
        return obj;
      }
      return {
        SingleLine1: read('SingleLine1'), SingleLine2: read('SingleLine2'), SingleLine3: read('SingleLine3'),
        MultiLine1: read('MultiLine1'), MultiLine2: read('MultiLine2'), MultiLine3: read('MultiLine3'),
        NumericLine1: read('NumericLine1'), NumericLine2: read('NumericLine2'), NumericLine3: read('NumericLine3'),
        BoolLine1: read('BoolLine1'), BoolLine2: read('BoolLine2'), BoolLine3: read('BoolLine3')
      };
    }
    function collectCustomId(){
      const rows = document.querySelectorAll('#customIdElements [data-row]');
      const list = [];
      rows.forEach((row, idx) => {
        const get = sel => row.querySelector(sel)?.value || '';
        const type = get('[data-prop="Type"]');
        const e = {
          Type: type,
          Position: idx,
          SeparatorBefore: get('[data-prop="SeparatorBefore"]').slice(0,1) || null,
          SeparatorAfter: get('[data-prop="SeparatorAfter"]').slice(0,1) || null
        };
        if (type === 'FixedText') e.FixedText = get('[data-prop="FixedText"]');
        else if (type === 'DateTime') e.DateTimeFormat = get('[data-prop="DateTimeFormat"]').toString() || 'yyyy';
        else if (type) {
          e.PaddingChar = (get('[data-prop="PaddingChar"]').slice(0,1) || null);
          e.Radix = get('[data-prop="Radix"]').toString() || '10';
        }
        list.push(e);
      });
      return list;
    }

    function snapshot(){
      return {
        Title: collectGeneral().Title,
        Description: collectGeneral().Description,
        CategoryId: collectGeneral().CategoryId,
        IsPublic: collectVisibility().IsPublic,
        UserIds: collectVisibility().UserIds,
        SingleLine1: collectCustomFields().SingleLine1,
        SingleLine2: collectCustomFields().SingleLine2,
        SingleLine3: collectCustomFields().SingleLine3,
        MultiLine1: collectCustomFields().MultiLine1,
        MultiLine2: collectCustomFields().MultiLine2,
        MultiLine3: collectCustomFields().MultiLine3,
        NumericLine1: collectCustomFields().NumericLine1,
        NumericLine2: collectCustomFields().NumericLine2,
        NumericLine3: collectCustomFields().NumericLine3,
        BoolLine1: collectCustomFields().BoolLine1,
        BoolLine2: collectCustomFields().BoolLine2,
        BoolLine3: collectCustomFields().BoolLine3,
        CustomIdElements: collectCustomId()
      };
    }

    let baseline = snapshot();

    function markChanged(group){
      if (!group) return;
      changedGroups.add(group);
      schedule();
    }

    document.getElementById('editTitle')?.addEventListener('input', () => markChanged('general'));
    document.getElementById('editDescription')?.addEventListener('input', () => markChanged('general'));
    document.getElementById('editCategory')?.addEventListener('change', () => markChanged('general'));
    document.getElementById('editIsPublic')?.addEventListener('change', () => markChanged('visibility'));
    document.getElementById('allowedUsersSection')?.addEventListener('change', () => markChanged('visibility'));
    document.getElementById('allowedUsersSection')?.addEventListener('click', (e) => {
      if (e.target.closest('[data-user-id]') || e.target.closest('.btn-close')) markChanged('visibility');
    });
    document.getElementById('customFields')?.addEventListener('input', () => markChanged('customFields'));
    document.getElementById('customIdElements')?.addEventListener('input', () => markChanged('customId'));
    document.addEventListener('edit-changed', (e) => { if (e?.detail?.group) markChanged(e.detail.group); });

    async function autosave(){
      clearTimeout(timerId); clearInterval(tickId);
      const groups = Array.from(changedGroups);
      if (groups.length === 0) { resetBtnText(); return; }
      statusEl.textContent = 'Saving...';
      try {
        const body = {
          Version: parseInt(versionEl?.value || '0') || 0,
          ChangedGroups: groups,
          Changes: Object.assign({ Version: parseInt(versionEl?.value || '0') || 0 }, snapshot()),
          Original: Object.assign({ Version: parseInt(versionEl?.value || '0') || 0 }, baseline)
        };
        const res = await fetch(`${window.location.pathname}?handler=AutoSave&guid=${encodeURIComponent(invGuid)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': token,
            'X-RequestVerificationToken': token
          },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        if (data && data.ok){
          const applied = new Set(Array.isArray(data.appliedGroups) ? data.appliedGroups.map(x=>String(x).toLowerCase()) : []);
          groups.forEach(g => { if (applied.has(String(g).toLowerCase())) changedGroups.delete(g); });
          if (typeof data.version === 'number'){
            versionEl.value = String(data.version);
          }
          baseline = snapshot();
          if (Array.isArray(data.conflicts) && data.conflicts.length > 0){
            const msgs = data.conflicts.map(c => `Conflict in ${c.group}: ${c.message}`).join(' ');
            statusEl.innerHTML = `<span class="text-warning">${msgs}</span>`;
          } else {
            statusEl.textContent = 'Saved.';
          }
        } else {
          statusEl.innerHTML = `<span class="text-danger">Failed to save.</span>`;
        }
      } catch {
        statusEl.innerHTML = `<span class="text-danger">Failed to save.</span>`;
      } finally {
        resetBtnText();
      }
    }

  })();
})();
</script>
}