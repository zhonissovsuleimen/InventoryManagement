@page "{guid:guid}"
@using Markdig
@model InventoryManagement.Pages.Inventory.DetailsModel

@{
    var inv = Model.Inventory;
    ViewData["Title"] = "Details";

    var allowedCount = (inv != null && !inv.IsPublic) ? (inv.AllowedUsers?.Count ?? 0) : 0;
    var usersLabel = allowedCount == 1 ? "user" : "users";
    var visibility = (inv?.IsPublic == true) ? "Public" : $"Private ({allowedCount} {usersLabel})";

    var createdAtUtc = inv?.CreatedAt.ToUniversalTime().ToString("o");
    var updatedAtUtc = inv?.UpdatedAt.ToUniversalTime().ToString("o");

    var ownerFullName = (inv?.Owner.FirstName ?? "") + " " + (inv?.Owner.LastName ?? "");

    var customFieldList = new List<(string Type, short? Position, string? Title, string? Description)>();
    if (inv != null)
    {
        void Add(string type, InventoryManagement.Models.Inventory.CustomField? f)
        {
            if (f != null && f.IsUsed) customFieldList.Add((type, f.Position, f.Title, f.Description));
        }

        Add("Single line", inv.SingleLine1);
        Add("Single line", inv.SingleLine2);
        Add("Single line", inv.SingleLine3);
        Add("Multi line", inv.MultiLine1);
        Add("Multi line", inv.MultiLine2);
        Add("Multi line", inv.MultiLine3);
        Add("Numeric", inv.NumericLine1);
        Add("Numeric", inv.NumericLine2);
        Add("Numeric", inv.NumericLine3);
        Add("Boolean", inv.BoolLine1);
        Add("Boolean", inv.BoolLine2);
        Add("Boolean", inv.BoolLine3);

        customFieldList = customFieldList.OrderBy(cf => cf.Position ?? short.MaxValue).ToList();
    }

    string PrettyElementName(string t) => t switch
    {
        "FixedText" => "Fixed Text",
        "Bit20" => "20-bit",
        "Bit32" => "32-bit",
        "Digit6" => "6 Character Digit",
        "Digit9" => "9 Character Digit",
        "Guid" => "GUID",
        "DateTime" => "Date/Time",
        _ => t
    };

    var customIdElements = new List<dynamic>();
    if (inv?.CustomId?.Elements != null)
    {
        foreach (var e in inv.CustomId.Elements)
        {
            if (e == null) continue;
            var type = e.GetType().Name.Replace("Element", "");
            customIdElements.Add(new {
                Type = type,
                DisplayType = PrettyElementName(type),
                e.Position,
                e.SeparatorBefore,
                e.SeparatorAfter,
                Element = e
            });
        }
        customIdElements = customIdElements
            .OrderBy(e => (short?)(e.Position ?? short.MaxValue))
            .ThenBy(e => e.Type)
            .ToList();
    }
}

<h1 class="mb-3">Details</h1>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center d-flex flex-column">
                @if (!string.IsNullOrWhiteSpace(inv?.ImageUrl))
                {
                    <img src="@inv.ImageUrl" alt="Image" class="img-fluid mb-3" style="max-height:260px; object-fit:contain;" />
                }
                else
                {
                    <div class="border rounded d-flex align-items-center justify-content-center mb-3" style="height:220px; background:#f8f9fa;">
                        <span class="text-muted">No image</span>
                    </div>
                }

                <h5 class="card-title mb-1 text-truncate">@Html.DisplayFor(m => m.Inventory.Title)</h5>
                @if (!string.IsNullOrWhiteSpace(inv?.Category?.Name))
                {
                    <p class="card-text text-muted small mb-0">@inv.Category.Name</p>
                }
                <hr />
                <div class="card-text mt-2 text-break mb-3">@Html.Raw(Markdown.ToHtml(inv?.Description ?? ""))</div>

                @if (inv?.Tags != null && inv.Tags.Count > 0)
                {
                    <div class="d-flex flex-wrap gap-1 mb-3 justify-content-center">
                        @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                        {
                            <span class="badge rounded-pill bg-secondary">@tag.Name</span>
                        }
                    </div>
                }

                <div class="mt-auto w-100">
                    <a asp-page="../Items/Create" asp-route-guid="@inv?.Guid" class="btn btn-primary btn-sm w-100">Create Item</a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-fields-tab" data-bs-toggle="tab" data-bs-target="#custom-fields" type="button" role="tab">Custom Fields</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">Items</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-id-tab" data-bs-toggle="tab" data-bs-target="#custom-id" type="button" role="tab">Custom ID</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags" type="button" role="tab">Tags</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab">Discussion</button>
            </li>
        </ul>
        <div class="tab-content border border-top-0 p-3" id="detailTabsContent">
            <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                <h4 class="mb-2">Inventory</h4>
                <hr />
                <dl class="row">
                    @if (inv?.Guid != null)
                    {
                        <dt class="col-sm-3">Identifier</dt>
                        <dd class="col-sm-9">
                            <div class="text-monospace small text-break">@inv.Guid.ToString()</div>
                        </dd>
                    }

                    @if (!string.IsNullOrWhiteSpace(inv?.Category?.Name))
                    {
                        <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.Category)</dt>
                        <dd class="col-sm-9">@inv.Category.Name</dd>
                    }

                    @if (inv?.Owner != null)
                    {
                        <dt class="col-sm-3">Owner</dt>
                        <dd class="col-sm-9">@ownerFullName (@inv.Owner.Email)</dd>
                    }

                    <dt class="col-sm-3">Visibility</dt>
                    <dd class="col-sm-9">@visibility</dd>

                    @if (inv?.Tags != null && inv.Tags.Count > 0)
                    {
                        <dt class="col-sm-3">Tags</dt>
                        <dd class="col-sm-9">
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                                {
                                    <span class="badge rounded-pill bg-secondary">@tag.Name</span>
                                }
                            </div>
                        </dd>
                    }

                    @if (!string.IsNullOrWhiteSpace(createdAtUtc))
                    {
                        <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.CreatedAt)</dt>
                        <dd class="col-sm-9" data-utc="@createdAtUtc">@DateTime.Parse(createdAtUtc).ToString("MMMM d, yyyy")</dd>
                    }

                    @if (!string.IsNullOrWhiteSpace(updatedAtUtc))
                    {
                        <dt class="col-sm-3">@Html.DisplayNameFor(m => m.Inventory.UpdatedAt)</dt>
                        <dd class="col-sm-9" data-utc="@updatedAtUtc">@DateTime.Parse(updatedAtUtc).ToString("MMMM d, yyyy")</dd>
                    }
                </dl>
            </div>

            <div class="tab-pane fade" id="custom-fields" role="tabpanel" aria-labelledby="custom-fields-tab">
                @if (customFieldList.Count > 0)
                {
                    <h5 class="mb-3">Custom fields</h5>
                    <div class="d-grid gap-3">
                        @for (int i = 0; i < customFieldList.Count; i++)
                        {
                            var cf = customFieldList[i];
                            var index = i + 1;
                            var title = string.IsNullOrWhiteSpace(cf.Title) ? "(no title)" : cf.Title;
                            var desc = string.IsNullOrWhiteSpace(cf.Description) ? "(no description)" : cf.Description;

                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-secondary">@index</span>
                                            <h6 class="mb-0">@title</h6>
                                        </div>
                                        <small class="text-muted">@cf.Type</small>
                                    </div>
                                    <div class="card-text">@desc</div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted">No custom fields configured.</div>
                }
            </div>

            <div class="tab-pane fade" id="items" role="tabpanel" aria-labelledby="items-tab">
                <h5 class="mb-3">Items</h5>
                @if (inv?.Items != null && inv.Items.Count > 0)
                {
                    @await Html.PartialAsync("~/Pages/Shared/_ItemsTable.cshtml", new InventoryManagement.Models.ViewModels.ItemsTableModel
                    {
                        Items = inv.Items,
                        ShowInventoryColumn = false
                    })
                }
                else
                {
                    <div class="text-muted">No items found for this inventory.</div>
                }
            </div>

            <div class="tab-pane fade" id="custom-id" role="tabpanel" aria-labelledby="custom-id-tab">
                <h5 class="mb-3">Custom ID structure</h5>
                @if (customIdElements.Count > 0)
                {
                    <div class="d-grid gap-3">
                        @{ var idx = 1; }
                        @foreach (var ce in customIdElements)
                        {
                            var element = ce.Element;
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-secondary">@idx</span>
                                            <h6 class="mb-0">@ce.DisplayType</h6>
                                        </div>
                                    </div>
                                    <dl class="row mb-0">
                                        @if (ce.SeparatorBefore != null)
                                        {
                                            <dt class="col-sm-3">Separator before</dt>
                                            <dd class="col-sm-9">@ce.SeparatorBefore.ToString()</dd>
                                        }
                                        @if (ce.SeparatorAfter != null)
                                        {
                                            <dt class="col-sm-3">Separator after</dt>
                                            <dd class="col-sm-9">@ce.SeparatorAfter.ToString()</dd>
                                        }

                                        @* Type specific hints *@
                                        @if (element is InventoryManagement.Models.Inventory.CustomId.Element.AbstractNumericElement num)
                                        {
                                            <dt class="col-sm-3">Radix</dt>
                                            <dd class="col-sm-9">@num.Radix</dd>
                                            @if (num.PaddingChar.HasValue)
                                            {
                                                <dt class="col-sm-3">Padding</dt>
                                                <dd class="col-sm-9">@num.PaddingChar.ToString()</dd>
                                            }
                                        }
                                        else if (element is InventoryManagement.Models.Inventory.CustomId.Element.DateTimeElement dt)
                                        {
                                            @if (!string.IsNullOrEmpty(dt.DateTimeFormat))
                                            {
                                                <dt class="col-sm-3">Format</dt>
                                                <dd class="col-sm-9">@dt.DateTimeFormat</dd>
                                            }
                                        }
                                        else if (element is InventoryManagement.Models.Inventory.CustomId.Element.FixedTextElement ft)
                                        {
                                            @if (!string.IsNullOrEmpty(ft.FixedText))
                                            {
                                                <dt class="col-sm-3">Text</dt>
                                                <dd class="col-sm-9">@ft.FixedText</dd>
                                            }
                                        }
                                    </dl>
                                </div>
                            </div>
                            idx++;
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted">No Custom ID configured for this inventory.</div>
                }
            </div>

            <div class="tab-pane fade" id="tags" role="tabpanel" aria-labelledby="tags-tab">
                <h5 class="mb-3">Tags</h5>
                @if (inv?.Tags != null && inv.Tags.Count > 0)
                {
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @foreach (var tag in inv.Tags.OrderBy(t => t.Name))
                        {
                            <span class="badge rounded-pill bg-secondary">@tag.Name</span>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted mb-3">No tags for this inventory.</div>
                }

                @if (User?.Identity?.IsAuthenticated == true)
                {
                    <form method="post" asp-page-handler="AddTag" class="d-flex gap-2 align-items-start position-relative">
                        <input type="hidden" name="guid" value="@inv.Guid" />
                        <div class="flex-grow-1">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="newTag" name="tag" placeholder="Add a tag" autocomplete="off" />
                                <label for="newTag">Add tag</label>
                            </div>
                            <div id="tagSuggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none; max-height:220px; overflow:auto;"></div>
                        </div>
                        <button class="btn btn-primary" type="submit">Add</button>
                    </form>
                }
                else
                {
                    <div class="text-muted small">Sign in to add tags.</div>
                }
            </div>

            <div class="tab-pane fade" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                @if (User?.Identity?.IsAuthenticated == true)
                {
                    <div class="mb-2">
                        <form id="postForm">
                            @Html.AntiForgeryToken()
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Write a comment in Markdown..." id="postContent" style="height:120px"></textarea>
                                <label for="postContent">New post</label>
                            </div>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="submit" class="btn btn-primary btn-sm">Post</button>
                            </div>
                        </form>
                    </div>
                }
                else
                {
                    <div class="text-muted">Sign in to participate in the discussion.</div>
                }
                <hr />
                <div id="posts" class="d-grid gap-3"></div>
            </div>
        </div>
        <div class="mt-3">
            <a asp-page="./Index" class="btn btn-secondary btn-sm">Back to list</a>
        </div>
    </div>
</div>

@section Scripts {
<script>
(() => {
  const invGuid = '@inv?.Guid';
  if (!invGuid) return;
  const postsEl = document.getElementById('posts');
  const form = document.getElementById('postForm');
  const contentEl = document.getElementById('postContent');
  const afEl = document.querySelector('#postForm input[name="__RequestVerificationToken"]');
  let lastId = 0;

  const tabsRoot = document.getElementById('detailTabs');
  function activateFromHash() {
    const hash = window.location.hash;
    if (!hash) return;
    const trigger = tabsRoot?.querySelector(`[data-bs-target="${hash}"]`);
    if (trigger && window.bootstrap && bootstrap.Tab) {
      new bootstrap.Tab(trigger).show();
    }
  }
  tabsRoot?.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', (e) => {
      const target = e.target?.getAttribute('data-bs-target');
      if (target) {
        history.replaceState(null, '', target);
      }
    });
  });
  if (window.location.hash) {
    activateFromHash();
  }
  window.addEventListener('hashchange', activateFromHash);

  function userDisplay(u){
    const name = ([(u.firstName||''),(u.lastName||'')].join(' ').trim()) || (u.userName||'(user)');
    return name;
  }

  function renderPost(p) {
    const wrapper = document.createElement('div');
    wrapper.className = 'card';
    wrapper.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <a href="/Users/Details?id=${encodeURIComponent(p.user.id)}">${userDisplay(p.user)}</a>
            <div class="text-muted small">${new Date(p.createdAtUtc + 'Z').toLocaleString()}</div>
          </div>
        </div>
        <div class="markdown">${p.html}</div>
      </div>`;
    postsEl.appendChild(wrapper);
  }

  async function fetchNew() {
    try {
      const url = new URL(`${window.location.pathname}?handler=Discussion`, window.location.origin);
      if (lastId > 0) url.searchParams.set('afterId', String(lastId));
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      if (Array.isArray(data)) {
        for (const p of data) {
          renderPost(p);
          lastId = Math.max(lastId, p.id);
        }
      }
    } catch {}
  }

  async function initLoad(){
    lastId = 0;
    postsEl.innerHTML = '';
    await fetchNew();
    setInterval(fetchNew, 3000);
  }

  document.getElementById('discussion-tab')?.addEventListener('shown.bs.tab', initLoad, { once: true });
  if (window.location.hash === '#discussion') {
    initLoad();
  }

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = contentEl.value.trim();
      if (!content) return;
      const headers = { 'Content-Type': 'application/json' };
      const token = afEl?.value;
      if (token) {
        headers['RequestVerificationToken'] = token;
        headers['X-RequestVerificationToken'] = token;
      }
      const res = await fetch(`${window.location.pathname}?handler=Discussion`, {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        contentEl.value = '';
        await fetchNew();
      }
    });
  }

  const newTagInput = document.getElementById('newTag');
  const tagList = document.getElementById('tagSuggestions');
  function clearTagList(){ tagList.innerHTML=''; tagList.style.display='none'; }
  function renderTagItem(name){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'list-group-item list-group-item-action';
    btn.textContent = name;
    btn.addEventListener('click', () => { newTagInput.value = name; clearTagList(); newTagInput.focus(); });
    return btn;
  }
  function renderNoResults(){
    const div = document.createElement('div');
    div.className = 'list-group-item text-muted';
    div.textContent = 'No tags found';
    return div;
  }
  function searchTags(q){
    const term = (q||'').trim();
    if (!term){ clearTagList(); return; }
    fetch(`/api/search/tags?query=${encodeURIComponent(term)}`)
      .then(r => r.ok ? r.json() : [])
      .then(items => {
        if (!Array.isArray(items)) { clearTagList(); return; }
        tagList.innerHTML = '';
        if (items.length === 0) {
          tagList.appendChild(renderNoResults());
        } else {
          items.forEach(x => tagList.appendChild(renderTagItem(x.name)));
        }
        tagList.style.display = 'block';
      })
      .catch(() => clearTagList());
  }
  newTagInput?.addEventListener('input', () => searchTags(newTagInput.value));
  document.addEventListener('click', (e) => {
    if (!(tagList.contains(e.target) || e.target === newTagInput)) clearTagList();
  });
})();
</script>
}