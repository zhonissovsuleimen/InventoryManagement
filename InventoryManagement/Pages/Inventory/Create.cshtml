@page
@model InventoryManagement.Pages.Inventory.CreateModel

@{
    ViewData["Title"] = "Create Inventory";
}

<h1>Create Inventory</h1>
<h4 id="stepTitle">Inventory</h4>

<hr />
<div class="row">
    <div class="col-md-8">
        <form method="post" enctype="multipart/form-data" id="inventoryForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Step" id="stepField" />

            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <section data-step="1">
                <div class="form-group">
                    <label asp-for="Input.Title" class="control-label"></label>
                    <input asp-for="Input.Title" class="form-control" />
                    <span asp-validation-for="Input.Title" class="text-danger"></span>
                </div>
                
                <div class="form-group">
                    <label asp-for="Input.Description" class="control-label"></label>
                    <textarea asp-for="Input.Description" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Input.Description" class="text-danger"></span>
                </div>
                
                <div class="form-group">
                    <label asp-for="Input.CategoryId" class="control-label">Category</label>
                    <select asp-for="Input.CategoryId" class="form-control" asp-items="Model.Categories">
                    </select>
                    <span asp-validation-for="Input.CategoryId" class="text-danger"></span>
                </div>
                
                <div class="form-group">
                    <label asp-for="Input.Image" class="control-label">Image</label>
                    <input asp-for="Input.Image" type="file" accept="image/*" class="form-control" id="imageInput" />
                    <img id="imagePreview" src="#" alt="Preview" style="display:none; max-width:100%; max-height:200px; margin-top:10px;" />
                    <span asp-validation-for="Input.Image" class="text-danger"></span>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <a href="@Url.Page(null, new { step = 2 })" class="btn btn-primary" data-next>Next</a>
                </div>
            </section>

            <section data-step="2">
                <div class="form-text mb-2">Define a Custom Id pattern for items in this inventory. Reorder elements freely.</div>
                <div class="card mb-3">
                    <div class="card-body py-2 d-flex align-items-center gap-2">
                        <strong class="me-2">Preview:</strong>
                        <code id="customIdPreview" class="text-muted">(empty)</code>
                    </div>
                </div>

                <div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
                    <span class="me-2">Add element:</span>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="FixedText">Text</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="Digit6">Random 6 digits</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="Digit9">Random 9 digits</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="Bit20">Random 20-bit</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="Bit32">Random 32-bit</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="DateTime">Date/Time</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-add-customid="Guid">Guid</button>
                </div>

                <div id="customIdElements" class="d-grid gap-2"></div>

                <template id="templateCustomIdRow">
                    <div class="card shadow-sm" data-row>
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary" data-type-label>Element</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-end">
                                <input type="hidden" data-prop="Type" />
                                <div class="col-auto">
                                    <label class="form-label small mb-0">Separator before</label>
                                    <input class="form-control form-control-sm" data-prop="SeparatorBefore" maxlength="1" placeholder="-" />
                                </div>
                                <div class="col-auto">
                                    <label class="form-label small mb-0">Separator after</label>
                                    <input class="form-control form-control-sm" data-prop="SeparatorAfter" maxlength="1" placeholder="-" />
                                </div>
                                <div class="col d-flex flex-wrap align-items-end gap-2" data-specific></div>
                            </div>
                        </div>
                    </div>
                </template>

                <template id="templateSpecificFixedText">
                    <div class="d-flex flex-column">
                        <label class="form-label small mb-0">Text</label>
                        <input class="form-control form-control-sm" data-prop="FixedText" placeholder="Fixed text" />
                    </div>
                </template>

                <template id="templateSpecificDateTime">
                    <div class="d-flex flex-column">
                        <label class="form-label small mb-0">Format</label>
                        <input class="form-control form-control-sm" data-prop="DateTimeFormat" placeholder="yyyyMMdd-HHmm" />
                    </div>
                </template>

                <template id="templateSpecificGuid">
                    <div class="d-flex flex-column" style="min-width: 120px;">
                        <label class="form-label small mb-0">Guid</label>
                        <input class="form-control form-control-sm" value="auto" disabled />
                    </div>
                </template>

                <template id="templateSpecificNumeric">
                    <div class="d-flex flex-wrap align-items-end gap-2">
                        <div class="d-flex flex-column" style="width: 80px;">
                            <label class="form-label small mb-0">Padding</label>
                            <input class="form-control form-control-sm" data-prop="PaddingChar" maxlength="1" placeholder="0" />
                        </div>
                        <div class="d-flex flex-column" style="width: 110px;">
                            <label class="form-label small mb-0">Radix</label>
                            <select class="form-select form-select-sm" data-prop="Radix">
                                <option value="2">Binary</option>
                                <option value="8">Octal</option>
                                <option value="10" selected>Decimal</option>
                                <option value="16">Hex</option>
                            </select>
                        </div>
                    </div>
                </template>

                <div class="d-flex justify-content-between gap-2 mt-3">
                    <a href="@Url.Page(null, new { step = 1 })" class="btn btn-secondary" data-prev>Previous</a>
                    <a href="@Url.Page(null, new { step = 3 })" class="btn btn-primary" data-next>Next</a>
                </div>
            </section>

            <section data-step="3">
                <div class="form-text mb-3">Up to 3 of each type. Drag the card to reorder.</div>

                <div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
                    <button type="button" class="btn btn-outline-primary" data-add-type="SingleLine">
                        Single Line <span class="badge bg-secondary ms-1" data-count="SingleLine">0/3</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-add-type="MultiLine">
                        Multi Line <span class="badge bg-secondary ms-1" data-count="MultiLine">0/3</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-add-type="NumericLine">
                        Numeric <span class="badge bg-secondary ms-1" data-count="NumericLine">0/3</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-add-type="BoolLine">
                        Boolean <span class="badge bg-secondary ms-1" data-count="BoolLine">0/3</span>
                    </button>
                </div>

                <div id="customFields" class="d-grid gap-2">
                    <div class="card shadow-sm" data-type="SingleLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Single Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine1.Title">Title</label>
                                    <input asp-for="Input.SingleLine1.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.SingleLine1.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine1.Description">Description</label>
                                    <input asp-for="Input.SingleLine1.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.SingleLine1.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.SingleLine1.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.SingleLine1.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="SingleLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Single Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine2.Title">Title</label>
                                    <input asp-for="Input.SingleLine2.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.SingleLine2.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine2.Description">Description</label>
                                    <input asp-for="Input.SingleLine2.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.SingleLine2.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.SingleLine2.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.SingleLine2.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="SingleLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Single Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine3.Title">Title</label>
                                    <input asp-for="Input.SingleLine3.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.SingleLine3.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.SingleLine3.Description">Description</label>
                                    <input asp-for="Input.SingleLine3.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.SingleLine3.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.SingleLine3.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.SingleLine3.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>

                    <div class="card shadow-sm" data-type="MultiLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Multi Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine1.Title">Title</label>
                                    <input asp-for="Input.MultiLine1.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.MultiLine1.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine1.Description">Description</label>
                                    <input asp-for="Input.MultiLine1.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.MultiLine1.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.MultiLine1.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.MultiLine1.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="MultiLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Multi Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine2.Title">Title</label>
                                    <input asp-for="Input.MultiLine2.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.MultiLine2.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine2.Description">Description</label>
                                    <input asp-for="Input.MultiLine2.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.MultiLine2.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.MultiLine2.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.MultiLine2.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="MultiLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Multi Line</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine3.Title">Title</label>
                                    <input asp-for="Input.MultiLine3.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.MultiLine3.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.MultiLine3.Description">Description</label>
                                    <input asp-for="Input.MultiLine3.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.MultiLine3.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.MultiLine3.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.MultiLine3.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>

                    <div class="card shadow-sm" data-type="NumericLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Numeric</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine1.Title">Title</label>
                                    <input asp-for="Input.NumericLine1.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.NumericLine1.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine1.Description">Description</label>
                                    <input asp-for="Input.NumericLine1.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.NumericLine1.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.NumericLine1.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.NumericLine1.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="NumericLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Numeric</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine2.Title">Title</label>
                                    <input asp-for="Input.NumericLine2.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.NumericLine2.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine2.Description">Description</label>
                                    <input asp-for="Input.NumericLine2.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.NumericLine2.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.NumericLine2.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.NumericLine2.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="NumericLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Numeric</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine3.Title">Title</label>
                                    <input asp-for="Input.NumericLine3.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.NumericLine3.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.NumericLine3.Description">Description</label>
                                    <input asp-for="Input.NumericLine3.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.NumericLine3.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.NumericLine3.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.NumericLine3.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>

                    <div class="card shadow-sm" data-type="BoolLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Boolean</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine1.Title">Title</label>
                                    <input asp-for="Input.BoolLine1.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.BoolLine1.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine1.Description">Description</label>
                                    <input asp-for="Input.BoolLine1.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.BoolLine1.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.BoolLine1.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.BoolLine1.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="BoolLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Boolean</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine2.Title">Title</label>
                                    <input asp-for="Input.BoolLine2.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.BoolLine2.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine2.Description">Description</label>
                                    <input asp-for="Input.BoolLine2.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.BoolLine2.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.BoolLine2.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.BoolLine2.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                    <div class="card shadow-sm" data-type="BoolLine" data-used="false">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge text-bg-secondary">Boolean</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove>Remove</button>
                            </div>
                            <div class="row g-2 align-items-start">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine3.Title">Title</label>
                                    <input asp-for="Input.BoolLine3.Title" class="form-control form-control-sm" data-field="title" placeholder="Title" />
                                    <span asp-validation-for="Input.BoolLine3.Title" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label small mb-1" asp-for="Input.BoolLine3.Description">Description</label>
                                    <input asp-for="Input.BoolLine3.Description" class="form-control form-control-sm" data-field="description" placeholder="Description" />
                                    <span asp-validation-for="Input.BoolLine3.Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <input asp-for="Input.BoolLine3.Position" type="hidden" data-field="position" />
                            <input asp-for="Input.BoolLine3.IsUsed" type="hidden" data-field="isUsed" />
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between gap-2 mt-3">
                    <a href="@Url.Page(null, new { step = 2 })" class="btn btn-secondary" data-prev>Previous</a>
                    <a href="@Url.Page(null, new { step = 4 })" class="btn btn-primary" data-next>Next</a>
                </div>
            </section>

            <section data-step="4">
                <div class="form-group form-check">
                    <label class="form-check-label">
                        <input class="form-check-input" asp-for="Input.IsPublic" /> @Html.DisplayNameFor(model => model.Input.IsPublic)
                    </label>
                </div>

                <div id="allowedUsersSection" class="mt-3" style="display:none;">
                    <label class="form-label">Allowed Users</label>
                    <div class="form-text mb-2">Type a name to find users and add them. Visible only when inventory is not public.</div>
                    <div class="position-relative">
                        <input type="text" id="userSearch" class="form-control" placeholder="Search users..." autocomplete="off" />
                        <div id="userSuggestions" class="list-group position-absolute w-100" style="z-index: 1050; display:none; max-height: 220px; overflow:auto;"></div>
                    </div>
                    <div id="selectedUsers" class="d-flex flex-wrap gap-2 mt-2"></div>
                    <div id="userIdsContainer" class="d-none">
                        <input type="hidden" asp-for="Input.UserIds" data-template="user-id" disabled />
                    </div>
                    <span asp-validation-for="Input.UserIds" class="text-danger"></span>
                </div>

                <div class="d-flex justify-content-between gap-2 mt-3">
                    <a href="@Url.Page(null, new { step = 3 })" class="btn btn-secondary" data-prev>Previous</a>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </section>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // step navigation and visibility
        (function(){
            const sections = document.querySelectorAll('section[data-step]');
            const stepField = document.getElementById('stepField');
            const links = document.querySelectorAll('[data-step-link]');
            const prevs = document.querySelectorAll('[data-prev]');
            const nexts = document.querySelectorAll('[data-next]');
            const titleEl = document.getElementById('stepTitle');
            const titles = { 1: 'Details', 2: 'Custom Id', 3: 'Custom Fields', 4: 'Visibility' };

            function clamp(n){ return Math.max(1, Math.min(4, n|0)); }

            function setUrlStep(step, replace=false){
                const url = new URL(window.location.href);
                url.searchParams.set('step', step);
                if(replace) history.replaceState({}, '', url);
                else history.pushState({}, '', url);
            }

            function setActiveNav(step){
                document.querySelectorAll('.pagination .page-item').forEach(li => li.classList.remove('active'));
                const active = document.querySelector(`.pagination [data-step-link="${step}"]`);
                if (active) active.closest('.page-item').classList.add('active');
            }

            function showStep(step){
                const s = clamp(step);
                sections.forEach(sec => {
                    sec.style.display = (sec.getAttribute('data-step') === String(s)) ? '' : 'none';
                });
                stepField.value = String(s);
                setActiveNav(s);
                if (titleEl) titleEl.textContent = titles[s] || 'Inventory';
            }

            function goTo(step, replace=false){
                showStep(step);
                setUrlStep(step, replace);
            }

            const initialStep = clamp(@Model.Step);
            showStep(initialStep);
            setUrlStep(initialStep, true);

            links.forEach(a => a.addEventListener('click', e => {
                e.preventDefault();
                const step = clamp(parseInt(a.getAttribute('data-step-link')||'1'));
                goTo(step);
            }));

            prevs.forEach(a => a.addEventListener('click', e => {
                e.preventDefault();
                const current = clamp(parseInt(stepField.value||'1'));
                goTo(current-1);
            }));
            nexts.forEach(a => a.addEventListener('click', e => {
                e.preventDefault();
                const current = clamp(parseInt(stepField.value||'1'));
                goTo(current+1);
            }));

            window.addEventListener('popstate', () => {
                const url = new URL(window.location.href);
                const s = clamp(parseInt(url.searchParams.get('step')||stepField.value||'1'));
                showStep(s);
            });
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script> //image preview
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');

        const showPreview = file => {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        if (input) {
            input.addEventListener('change', () => {
                if (input.files && input.files[0]) {
                    showPreview(input.files[0]);
                }
            });
        }
    </script>
    <script> // Allowed users search and selection
        (function() {
            const isPublicEl = document.getElementById('Input_IsPublic');
            const section = document.getElementById('allowedUsersSection');
            const searchInput = document.getElementById('userSearch');
            const suggestions = document.getElementById('userSuggestions');
            const selectedUsers = document.getElementById('selectedUsers');
            const userIdsContainer = document.getElementById('userIdsContainer');
            const template = userIdsContainer ? userIdsContainer.querySelector('input[data-template="user-id"]') : null;
            const selected = new Map();

            function toggleSection() {
                if (!isPublicEl) return;
                section.style.display = isPublicEl.checked ? 'none' : '';
            }

            if (isPublicEl) {
                isPublicEl.addEventListener('change', toggleSection);
                toggleSection();
            }

            let debounceAmount = 200;
            let debounceTimer = null;
            let currentAbort = null;

            function clearSuggestions() {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
            }

            function renderSuggestion(item) {
                const id = item.guid;
                const first = item.firstName || '';
                const last = item.lastName || '';
                const name = (first + ' ' + last).trim();

                const a = document.createElement('button');
                a.type = 'button';
                a.className = 'list-group-item list-group-item-action';
                a.textContent = name;
                a.addEventListener('click', () => {
                    addUser(id, name);
                    clearSuggestions();
                    searchInput.value = '';
                    searchInput.focus();
                });
                return a;
            }

            function addUser(id, name) {
                if (!id || selected.has(id)) return;
                selected.set(id, name);

                const chip = document.createElement('span');
                chip.className = 'badge rounded-pill text-bg-secondary d-inline-flex align-items-center gap-1 px-2 py-2';
                chip.dataset.userId = id;
                chip.textContent = name;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-close btn-close-white btn-sm ms-1';
                btn.ariaLabel = 'Remove';
                btn.addEventListener('click', () => removeUser(id));
                chip.appendChild(btn);
                selectedUsers.appendChild(chip);

                if (template && userIdsContainer) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = template.getAttribute('name');
                    hidden.value = id;
                    hidden.dataset.userId = id;
                    userIdsContainer.appendChild(hidden);
                }
            }

            function removeUser(id) {
                if (!selected.has(id)) return;
                selected.delete(id);
                const chip = selectedUsers.querySelector(`[data-user-id="${id}"]`);
                if (chip) chip.remove();
                const hidden = userIdsContainer.querySelector(`input[type="hidden"][data-user-id="${id}"]`);
                if (hidden) hidden.remove();
            }

            function search(q) {
                if (currentAbort) currentAbort.abort();
                if (!q) { clearSuggestions(); return; }
                const controller = new AbortController();
                currentAbort = controller;
                fetch(`/api/search/users?query=${encodeURIComponent(q)}`, { signal: controller.signal })
                    .then(r => r.ok ? r.json() : [])
                    .then(items => {
                        if (!Array.isArray(items)) { clearSuggestions(); return; }
                        suggestions.innerHTML = '';
                        items
                                   .filter(item => !(selected.has(item.guid)))
                            .forEach(item => suggestions.appendChild(renderSuggestion(item)));
                        suggestions.style.display = suggestions.childElementCount > 0 ? 'block' : 'none';
                    })
                    .catch(() => { clearSuggestions(); });
            }

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    window.clearTimeout(debounceTimer);
                    debounceTimer = window.setTimeout(() => search(searchInput.value), debounceAmount);
                });
                document.addEventListener('click', (e) => {
                    if (!suggestions.contains(e.target) && e.target !== searchInput) {
                        clearSuggestions();
                    }
                });
            }
        })();
    </script>
    <script> // Custom fields
        const fieldsContainer = document.getElementById('customFields');
        const addButtons = document.querySelectorAll('[data-add-type]');
        const typeLimit = 3;

        function countByType(type) {
            return [...fieldsContainer.querySelectorAll(`.card[data-type="${type}"]`)].filter(c => c.getAttribute('data-used') === 'true').length;
        }

        function updateCounters() {
            addButtons.forEach(btn => {
                const type = btn.getAttribute('data-add-type');
                const count = countByType(type);
                const badge = btn.querySelector(`[data-count="${type}"]`);
                if (badge) badge.textContent = `${count}/${typeLimit}`;
                btn.disabled = count >= typeLimit;
            });
        }

        function setCardUsed(card, used) {
            const isUsedInput = card.querySelector('[data-field="isUsed"]');
            if (isUsedInput) isUsedInput.value = used ? 'true' : 'false';
            card.setAttribute('data-used', used ? 'true' : 'false');
            card.style.display = used ? '' : 'none';
        }

        function assignSequentialPositions() {
            let pos = 0;
            const usedCards = [...fieldsContainer.querySelectorAll('.card')].filter(c => c.getAttribute('data-used') === 'true');
            usedCards.forEach(c => {
                const posEl = c.querySelector('[data-field="position"]');
                if (posEl) posEl.value = pos.toString();
                pos++;
            });
        }

        function wireRemove(card) {
            const removeBtn = card.querySelector('[data-remove]');
            if (!removeBtn) return;
            removeBtn.addEventListener('click', () => {
                const titleEl = card.querySelector('[data-field="title"]');
                const descEl = card.querySelector('[data-field="description"]');
                const posEl = card.querySelector('[data-field="position"]');
                if (titleEl) titleEl.value = '';
                if (descEl) descEl.value = '';
                if (posEl) posEl.value = '';
                setCardUsed(card, false);
                assignSequentialPositions();
                updateCounters();
            });
        }

        [...fieldsContainer.querySelectorAll('.card')].forEach(card => {
            wireRemove(card);
        });

        function addFieldOfType(type) {
            const candidates = [...fieldsContainer.querySelectorAll(`.card[data-type="${type}"]`)];
            const card = candidates.find(c => c.getAttribute('data-used') === 'false');
            if (!card) return;
            setCardUsed(card, true);
            assignSequentialPositions();
            updateCounters();
        }

        addButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-add-type');
                if (countByType(type) >= typeLimit) return;
                addFieldOfType(type);
            });
        });

        Sortable.create(fieldsContainer, {
            animation: 100,
            ghostClass: 'bg-light',
            filter: '.card[data-used="false"], button, input, textarea, select, label',
            preventOnFilter: false,
            onEnd: () => {
                assignSequentialPositions();
            }
        });

        function syncUiFromModel() {
            [...fieldsContainer.querySelectorAll('.card')].forEach(card => {
                const isUsedInput = card.querySelector('[data-field="isUsed"]');
                const used = isUsedInput && (isUsedInput.value === 'true' || isUsedInput.value === 'True');
                setCardUsed(card, used);
            });
            assignSequentialPositions();
            updateCounters();
        }

        syncUiFromModel();
    </script>
    <script> // Custom Id builder using API
        (function(){
            const container = document.getElementById('customIdElements');
            const previewEl = document.getElementById('customIdPreview');
            const addBtns = document.querySelectorAll('[data-add-customid]');

            const intMax = (2147483647 + 1);
			const seed = parseInt(intMax * Math.random());

            function collectElements(){
                const items = [];
                container.querySelectorAll('[data-row]').forEach(row => {
                    const obj = {};
                    const type = row.querySelector('[data-prop="Type"]').value;
                    obj.Type = type;
                    const sb = (row.querySelector('[data-prop="SeparatorBefore"]').value || '').slice(0,1);
                    const sa = (row.querySelector('[data-prop="SeparatorAfter"]').value || '').slice(0,1);
                    if (sb) obj.SeparatorBefore = sb;
                    if (sa) obj.SeparatorAfter = sa;
                    if (type === 'FixedText') {
                        obj.FixedText = row.querySelector('[data-prop="FixedText"]').value || '';
                    } else if (type === 'DateTime') {
                        obj.DateTimeFormat = row.querySelector('[data-prop="DateTimeFormat"]').value || 'yyyy';
                    } else if (type === 'Digit6' || type === 'Digit9' || type === 'Bit20' || type === 'Bit32') {
                        const radix = row.querySelector('[data-prop="Radix"]').value || '10';
                        const pad = (row.querySelector('[data-prop="PaddingChar"]').value || '').slice(0,1);
                        obj.Radix = radix;
                        if (pad) obj.PaddingChar = pad;
                    }
                    items.push(obj);
                });
                return items;
            }

            function setNames(){
                const rows = container.querySelectorAll('[data-row]');
                rows.forEach((row, idx) => {
                    row.querySelectorAll('[data-prop]').forEach(input => {
                        const prop = input.getAttribute('data-prop');
                        input.name = `Input.CustomIdElements[${idx}].${prop}`;
                    });
                });
            }

            async function generatePreview(){
                const elements = collectElements();
                if (elements.length === 0){
                    previewEl.textContent = '(empty)';
                    return;
                }
                try {
                    const resp = await fetch('/api/generate/customId', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ seed: seed, elements: elements })
                    });
                    if (!resp.ok) throw new Error('Failed');
                    const text = await resp.text();
                    previewEl.textContent = text || '(empty)';
                } catch {
                    previewEl.textContent = '(error)';
                }
            }

            function createSpecific(type){
                if (type === 'FixedText') return document.getElementById('templateSpecificFixedText').content.cloneNode(true);
                if (type === 'DateTime') return document.getElementById('templateSpecificDateTime').content.cloneNode(true);
                if (type === 'Guid') return document.getElementById('templateSpecificGuid').content.cloneNode(true);
                return document.getElementById('templateSpecificNumeric').content.cloneNode(true);
            }

            function addRow(type){
                const tpl = document.getElementById('templateCustomIdRow');
                const node = tpl.content.cloneNode(true);
                const card = node.querySelector('[data-row]');
                card.querySelector('[data-type-label]').textContent =
                    type === 'FixedText' ? 'Text' :
                    type === 'Digit6' ? 'Random 6 digits' :
                    type === 'Digit9' ? 'Random 9 digits' :
                    type === 'Bit20' ? 'Random 20-bit' :
                    type === 'Bit32' ? 'Random 32-bit' :
                    type === 'DateTime' ? 'Date/Time' :
                    type === 'Guid' ? 'Guid' : 'Element';
                const typeInput = card.querySelector('[data-prop="Type"]');
                typeInput.value = type;
                const specificHost = card.querySelector('[data-specific]');
                specificHost.appendChild(createSpecific(type));

                card.querySelector('[data-remove]').addEventListener('click', () => {
                    card.remove();
                    setNames();
                    generatePreview();
                });
                card.addEventListener('input', generatePreview);
                container.appendChild(card);
                setNames();
                generatePreview();
            }

            addBtns.forEach(btn => {
                btn.addEventListener('click', () => addRow(btn.getAttribute('data-add-customid')));
            });

            Sortable.create(container, {
                animation: 100,
                ghostClass: 'bg-light',
                handle: '',
                filter: 'button, input, textarea, select, label',
                preventOnFilter: false,
                onEnd: () => { setNames(); generatePreview(); }
            });

            generatePreview();
        })();
    </script>
}
