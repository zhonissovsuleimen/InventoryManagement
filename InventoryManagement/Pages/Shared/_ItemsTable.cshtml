@model InventoryManagement.Models.ViewModels.ItemsTableModel
@{
    var items = Model.Items ?? System.Array.Empty<InventoryManagement.Models.Item>();
}
@{
    bool showInventory = Model.ShowInventoryColumn;
    bool showLikeButton = User?.Identity?.IsAuthenticated == true;
    bool selectionMode = Model.EnableSelection;
    var clientId = "itemsTable_" + System.Guid.NewGuid().ToString("N");
    var deleteUrl = Model.DeleteUrl ?? string.Empty;
}

<div id="@clientId" class="items-table">
    @if (showLikeButton || selectionMode)
    {
        <form method="post" class="d-none">
            @Html.AntiForgeryToken()
        </form>
    }

    @if (selectionMode)
    {
        <div class="d-flex justify-content-between align-items-center mb-2" data-toolbar>
            <div class="btn-group btn-group-sm" role="group" aria-label="Selection actions">
                <button type="button" class="btn btn-outline-secondary" data-select-all>Select all</button>
                <button type="button" class="btn btn-outline-secondary" data-deselect-all>Deselect</button>
            </div>
            <button type="button" class="btn btn-sm btn-danger" data-delete-selected disabled>Delete selected</button>
        </div>
    }

    <table class="table table-striped table-hover table-bordered">
        <thead>
            <tr>
                @if (selectionMode)
                {
                    <th style="width:1%;" class="text-center align-middle">
                        <input type="checkbox" class="form-check-input" data-toggle-all />
                    </th>
                }
                else
                {
                    <th style="width:1%;" class="me-4 text-end align-middle">#</th>
                }
                <th>Custom ID</th>
                @if (showInventory)
                {
                    <th>Inventory</th>
                }
                <th>Creator</th>
                <th style="width:1%;" class="text-end">Likes</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < items.Count; i++)
            {
                var item = items[i];
                var likeCount = item.Likes?.Count ?? 0;
                var likedByMe = false;
                if (User?.Identity?.IsAuthenticated == true)
                {
                    var uid = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                    likedByMe = item.Likes?.Any(l => l.User != null && l.User.Id == uid) == true;
                }
                <tr data-item-guid="@item.Guid">
                    @if (selectionMode)
                    {
                        <td class="align-middle text-center">
                            <input type="checkbox" class="form-check-input" data-row-select />
                        </td>
                    }
                    else
                    {
                        <td class="align-middle text-end">@(i + 1)</td>
                    }
                    <td class="align-middle">
                        <a asp-page="/Items/Details" asp-route-guid="@item.Guid">@item.CustomId</a>
                    </td>
                    @if (showInventory)
                    {
                        <td class="align-middle">
                            @if (item.Inventory != null)
                            {<a asp-page="/Inventory/Details" asp-route-guid="@item.Inventory.Guid">@item.Inventory.Title</a>}
                            else
                            {<span>-</span>}
                        </td>
                    }
                    <td class="align-middle">@((item.Owner != null) ? (item.Owner.UserName + " (" + item.Owner.Email + ")") : "(unknown)")</td>
                    <td class="align-middle text-end">
                        @if (showLikeButton)
                        {
                            <button type="button" class="btn btn-sm btn-outline-primary like-btn @((likedByMe)?"active":"")" data-liked="@likedByMe.ToString().ToLower()" title="Like">
                                <span class="like-icon" aria-hidden="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                      <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                                    </svg>
                                </span>
                                <span class="like-count">@likeCount</span>
                            </button>
                        }
                        else
                        {
                            <span class="like-count">@likeCount</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
(() => {
  const root = document.getElementById('@clientId');
  if (!root) return;
  const headers = {};
  const token = root.querySelector('input[name="__RequestVerificationToken"]')?.value;
  if (token) {
    headers['RequestVerificationToken'] = token;
    headers['X-RequestVerificationToken'] = token;
  }

  // Likes
  root.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const tr = btn.closest('tr');
      const guid = tr?.getAttribute('data-item-guid');
      if (!guid) return;
      const res = await fetch(`/api/items/${encodeURIComponent(guid)}/like`, {
        method: 'POST',
        headers,
        credentials: 'same-origin'
      });
      if (!res.ok) return;
      const data = await res.json();
      const countEl = btn.querySelector('.like-count');
      btn.dataset.liked = data.liked ? 'true' : 'false';
      btn.classList.toggle('active', !!data.liked);
      if (countEl) countEl.textContent = String(data.count ?? 0);
    });
  });

  // Selection mode
  const selectionMode = @Model.EnableSelection.ToString().ToLower();
  if (selectionMode) {
    const toggleAll = root.querySelector('[data-toggle-all]');
    const selectAllBtn = root.querySelector('[data-select-all]');
    const deselectAllBtn = root.querySelector('[data-deselect-all]');
    const deleteBtn = root.querySelector('[data-delete-selected]');
    const rowCbs = () => Array.from(root.querySelectorAll('input[type="checkbox"][data-row-select]'));

    function updateDeleteState(){
      const any = rowCbs().some(cb => cb.checked);
      if (deleteBtn) deleteBtn.disabled = !any;
      if (toggleAll) toggleAll.checked = any && rowCbs().every(cb => cb.checked);
    }

    toggleAll?.addEventListener('change', () => {
      const checked = toggleAll.checked;
      rowCbs().forEach(cb => { cb.checked = checked; });
      updateDeleteState();
    });

    selectAllBtn?.addEventListener('click', () => {
      rowCbs().forEach(cb => cb.checked = true);
      updateDeleteState();
    });
    deselectAllBtn?.addEventListener('click', () => {
      rowCbs().forEach(cb => cb.checked = false);
      updateDeleteState();
    });
    root.addEventListener('change', (e) => {
      const t = e.target;
      if (t && t.matches && t.matches('input[type="checkbox"][data-row-select]')) updateDeleteState();
    });

    deleteBtn?.addEventListener('click', async () => {
      const guids = rowCbs().filter(cb => cb.checked).map(cb => cb.closest('tr')?.getAttribute('data-item-guid')).filter(Boolean);
      if (guids.length === 0) return;
      try {
        const res = await fetch('@(deleteUrl)', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...headers },
          credentials: 'same-origin',
          body: JSON.stringify({ guids })
        });
        if (!res.ok) return;
        const data = await res.json();
        const deleted = Array.isArray(data.deleted) ? data.deleted : [];
        deleted.forEach(id => {
          const tr = root.querySelector(`tr[data-item-guid="${id}"]`);
          if (tr) tr.remove();
        });
        updateDeleteState();
      } catch {}
    });
  }
})();
</script>
