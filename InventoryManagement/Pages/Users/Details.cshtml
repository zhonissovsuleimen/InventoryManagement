@page "{id?}"
@model InventoryManagement.Pages.Users.DetailsModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["User Details"].Value;
    var u = Model.UserModel;
    string FullName() {
        var fn = (u?.FirstName ?? "").Trim();
        var ln = (u?.LastName ?? "").Trim();
        var both = (fn + " " + ln).Trim();
        return string.IsNullOrWhiteSpace(both) ? (u?.UserName ?? Localizer["(user)"].Value) : both;
    }
    string DisplayPublic(bool b) => b ? Localizer["Public"].Value : Localizer["Private"].Value;
    var clientId = "userDetails_" + Guid.NewGuid().ToString("N");
}

<h1 class="mb-3 d-flex justify-content-between align-items-center">
    <span>@FullName()</span>
    @if ((Model.IsSelf || Model.IsAdmin) && !Model.EditMode)
    {
        <form method="get" class="m-0">
            <input type="hidden" name="id" value="@Model.Id" />
            <input type="hidden" name="edit" value="true" />
            <button type="submit" class="btn btn-outline-primary btn-sm">@Localizer["Edit"]</button>
        </form>
    }
</h1>

@if (u == null)
{
    <div class="alert alert-warning">@Localizer["User not found." ]</div>
}
else
{
    <ul class="nav nav-tabs" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">@Localizer["General"]</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="created-tab" data-bs-toggle="tab" data-bs-target="#created" type="button" role="tab">@Localizer["Created inventories"]</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="allowed-tab" data-bs-toggle="tab" data-bs-target="#allowed" type="button" role="tab">@Localizer["Allowed inventories"]</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="likes-tab" data-bs-toggle="tab" data-bs-target="#likes" type="button" role="tab">@Localizer["Likes"]</button>
        </li>
    </ul>
    <div class="tab-content border border-top-0 p-3" id="userTabsContent" data-root-id="@clientId">
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            @if (Model.IsSelf && Model.EditMode)
            {
                <form method="post" asp-page-handler="Edit" class="d-grid gap-3">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Input.FirstName" class="form-label">@Localizer["First name"]</label>
                            <input asp-for="Input.FirstName" class="form-control" />
                            <span asp-validation-for="Input.FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Input.LastName" class="form-label">@Localizer["Last name"]</label>
                            <input asp-for="Input.LastName" class="form-control" />
                            <span asp-validation-for="Input.LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="border rounded p-3">
                        <h6 class="mb-3">@Localizer["Change password"]</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="Input.CurrentPassword" class="form-label">@Localizer["Current password"]</label>
                                <input asp-for="Input.CurrentPassword" class="form-control" />
                                <span asp-validation-for="Input.CurrentPassword" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Input.NewPassword" class="form-label">@Localizer["New password"]</label>
                                <input asp-for="Input.NewPassword" class="form-control" />
                                <span asp-validation-for="Input.NewPassword" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Input.ConfirmPassword" class="form-label">@Localizer["Confirm password"]</label>
                                <input asp-for="Input.ConfirmPassword" class="form-control" />
                                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="form-text">@Localizer["Leave password fields empty to keep the current password."]</div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">@Localizer["Save"]</button>
                        <a asp-page="/Users/Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary btn-sm">@Localizer["Cancel"]</a>
                    </div>
                </form>
            }
            else
            {
                <dl class="row">
                    <dt class="col-sm-3">@Localizer["First name"]</dt>
                    <dd class="col-sm-9">@u.FirstName</dd>
                    <dt class="col-sm-3">@Localizer["Last name"]</dt>
                    <dd class="col-sm-9">@u.LastName</dd>
                    <dt class="col-sm-3">@Localizer["Email"]</dt>
                    <dd class="col-sm-9">@u.Email</dd>
                    <dt class="col-sm-3">@Localizer["Admin"]</dt>
                    <dd class="col-sm-9">@(u.IsAdmin ? Localizer["Yes"].Value : Localizer["No"].Value)</dd>
                    @if (Model.IsSelf)
                    {
                        <dt class="col-sm-3">@Localizer["Password"]</dt>
                        <dd class="col-sm-9"><span class="text-muted">@Localizer["Hidden"]</span></dd>
                    }
                </dl>
            }

            @* Admin controls: only visible to admins while in edit mode (self or another user) *@
            @if (Model.IsAdmin && Model.EditMode)
            {
                <div class="mt-3">
                    <div class="d-flex align-items-center gap-2">
                        <form method="post" asp-page-handler="MakeAdmin" class="m-0">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-sm btn-primary">@Localizer["Admin"]</button>
                        </form>
                        <form method="post" asp-page-handler="RemoveAdmin" class="m-0">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-primary">@Localizer["De-Admin"]</button>
                        </form>
                    </div>
                </div>
            }
        </div>
        <div class="tab-pane fade" id="created" role="tabpanel" aria-labelledby="created-tab">
            @if (Model.IsSelf && Model.EditMode)
            {
                <div class="d-flex justify-content-between align-items-center mb-2" id="@clientId-created-toolbar">
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-select-all>@Localizer["Select all"]</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-deselect-all>@Localizer["Deselect"]</button>
                        <button type="button" class="btn btn-sm btn-danger" data-delete-selected disabled>@Localizer["Delete selected"]</button>
                    </div>
                </div>
                <form method="post" class="d-none">
                    @Html.AntiForgeryToken()
                </form>
            }
            @if (Model.CreatedInventories.Count == 0)
            {
                <div class="text-muted">@Localizer["No inventories created."]</div>
            }
            else
            {
                <table class="table table-striped table-hover table-bordered" id="@clientId-created-table">
                    <thead>
                        <tr>
                            @if (Model.IsSelf && Model.EditMode)
                            {
                                <th style="width:1%;" class="text-center align-middle">
                                    <input type="checkbox" class="form-check-input" data-toggle-all />
                                </th>
                            }
                            else
                            {
                                <th style="width:1%;" class="text-end align-middle">#</th>
                            }
                            <th>@Localizer["Title"]</th>
                            <th>@Localizer["Description"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.CreatedInventories.Count; i++)
                        {
                            var inv = Model.CreatedInventories[i];
                            <tr data-inv-guid="@inv.Guid">
                                @if (Model.IsSelf && Model.EditMode)
                                {
                                    <td class="align-middle text-center">
                                        <input type="checkbox" class="form-check-input" data-row-select />
                                    </td>
                                }
                                else
                                {
                                    <td class="text-end">@(i + 1)</td>
                                }
                                <td><a asp-page="/Inventory/Details" asp-route-guid="@inv.Guid">@inv.Title</a></td>
                                <td>@inv.Description</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
        <div class="tab-pane fade" id="allowed" role="tabpanel" aria-labelledby="allowed-tab">
            @if (Model.AllowedInventories.Count == 0)
            {
                <div class="text-muted">@Localizer["No inventories allowed."]</div>
            }
            else
            {
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th style="width:1%;" class="text-end align-middle">#</th>
                            <th>@Localizer["Title"]</th>
                            <th>@Localizer["Description"]</th>
                            <th>@Localizer["Creator"]</th>
                            <th>@Localizer["Access Level"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.AllowedInventories.Count; i++)
                        {
                            var inv = Model.AllowedInventories[i];
                            var owner = inv?.Owner;
                            var ownerName = (owner?.FirstName + " " + owner?.LastName).Trim();
                            if (string.IsNullOrWhiteSpace(ownerName)) ownerName = owner?.UserName ?? Localizer["(user)"].Value;
                            <tr>
                                <td class="text-end">@(i + 1)</td>
                                <td><a asp-page="/Inventory/Details" asp-route-guid="@inv.Title">@inv.Title</a></td>
                                <td>@inv.Description</td>
                                <td>
                                    @if (owner != null)
                                    {
                                        <a asp-page="/Users/Details" asp-route-id="@owner.Id">@ownerName</a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">@Localizer["(unknown)"]</span>
                                    }
                                </td>
                                <td>@DisplayPublic(inv.IsPublic)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
        <div class="tab-pane fade" id="likes" role="tabpanel" aria-labelledby="likes-tab">
            @if (Model.LikedItems.Count == 0)
            {
                <div class="text-muted">@Localizer["No liked items."]</div>
            }
            else
            {
                @await Html.PartialAsync("~/Pages/Shared/_ItemsTable.cshtml", new InventoryManagement.Models.ViewModels.ItemsTableModel {
                    Items = Model.LikedItems,
                    ShowInventoryColumn = true,
                    EnableSelection = false,
                    DeleteUrl = null
                })
            }
        </div>
    </div>
}

@section Scripts {
<partial name="~/Pages/Shared/_ValidationScriptsPartial.cshtml" />
<script>
(() => {
  const rootId = '@clientId';
  const root = document.querySelector(`[data-root-id="${rootId}"]`);
  if (!root) return;
  const isEditingSelf = @((Model.IsSelf && Model.EditMode).ToString().ToLower());
  if (!isEditingSelf) return;

  const createdTab = document.getElementById('created');
  const toolbar = document.getElementById(rootId + '-created-toolbar');
  const table = document.getElementById(rootId + '-created-table');
  if (!createdTab || !toolbar || !table) return;

  const headers = {};
  const token = createdTab.querySelector('input[name="__RequestVerificationToken"]')?.value;
  if (token) {
    headers['RequestVerificationToken'] = token;
    headers['X-RequestVerificationToken'] = token;
  }

  const toggleAll = table.querySelector('[data-toggle-all]');
  const selectAllBtn = toolbar.querySelector('[data-select-all]');
  const deselectAllBtn = toolbar.querySelector('[data-deselect-all]');
  const deleteBtn = toolbar.querySelector('[data-delete-selected]');
  const rowCbs = () => Array.from(table.querySelectorAll('input[type="checkbox"][data-row-select]'));

  function updateDeleteState(){
    const any = rowCbs().some(cb => cb.checked);
    if (deleteBtn) deleteBtn.disabled = !any;
    if (toggleAll) toggleAll.checked = any && rowCbs().every(cb => cb.checked);
  }

  toggleAll?.addEventListener('change', () => {
    const checked = toggleAll.checked;
    rowCbs().forEach(cb => { cb.checked = checked; });
    updateDeleteState();
  });
  selectAllBtn?.addEventListener('click', () => {
    rowCbs().forEach(cb => cb.checked = true);
    updateDeleteState();
  });
  deselectAllBtn?.addEventListener('click', () => {
    rowCbs().forEach(cb => cb.checked = false);
    updateDeleteState();
  });
  table.addEventListener('change', (e) => {
    const t = e.target;
    if (t && t.matches && t.matches('input[type="checkbox"][data-row-select]')) updateDeleteState();
  });

  deleteBtn?.addEventListener('click', async () => {
    const guids = rowCbs().filter(cb => cb.checked).map(cb => cb.closest('tr')?.getAttribute('data-inv-guid')).filter(Boolean);
    if (guids.length === 0) return;
    try {
      const res = await fetch('@Url.Page(null, "DeleteCreatedInventories", new { id = Model.Id })', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...headers },
        credentials: 'same-origin',
        body: JSON.stringify({ guids })
      });
      if (!res.ok) return;
      const data = await res.json();
      const deleted = Array.isArray(data.deleted) ? data.deleted : [];
      deleted.forEach(id => {
        const tr = table.querySelector(`tr[data-inv-guid="${id}"]`);
        if (tr) tr.remove();
      });
      updateDeleteState();
    } catch {}
  });
})();
</script>
}
