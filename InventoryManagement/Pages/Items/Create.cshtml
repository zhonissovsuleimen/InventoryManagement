@page
@model InventoryManagement.Pages.Items.CreateModel

@{
ViewData["Title"] = "Create";
}
        
<h1>Create</h1>
        
    <h4>Item</h4>
    <hr />
    <div class="row">
    <div class="col-md-4">
        <form method="post" novalidate>
            <input type="hidden" asp-for="InventoryGuid" />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            @{ 
                var inv = Model.Inventory;
                var fields = new List<(string PropName, string FieldKind, short? Position, string? Title, string? Description)>();

                void Add(string prop, string kind, InventoryManagement.Models.Inventory.CustomField? cf)
                {
                    if (cf != null && cf.IsUsed) fields.Add((prop, kind, cf.Position, cf.Title, cf.Description));
                }

                Add("SingleLine1", "single", inv?.SingleLine1);
                Add("SingleLine2", "single", inv?.SingleLine2);
                Add("SingleLine3", "single", inv?.SingleLine3);

                Add("MultiLine1", "multi", inv?.MultiLine1);
                Add("MultiLine2", "multi", inv?.MultiLine2);
                Add("MultiLine3", "multi", inv?.MultiLine3);

                Add("NumericLine1", "numeric", inv?.NumericLine1);
                Add("NumericLine2", "numeric", inv?.NumericLine2);
                Add("NumericLine3", "numeric", inv?.NumericLine3);

                Add("BoolLine1", "bool", inv?.BoolLine1);
                Add("BoolLine2", "bool", inv?.BoolLine2);
                Add("BoolLine3", "bool", inv?.BoolLine3);

                fields = fields.OrderBy(f => f.Position ?? short.MaxValue).ToList();
            }

            @foreach (var f in fields)
            {
                <div class="form-group">
                    <label class="control-label">@f.Title
                        @if (!string.IsNullOrWhiteSpace(f.Description))
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle ms-2 text-muted" viewBox="0 0 16 16" style="cursor:help;" title="@f.Description" aria-hidden="true" focusable="false" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="false">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                            </svg>
                        }
                    </label>
                    @if (f.FieldKind == "single")
                    {
                        <input type="text" name="Input.@f.PropName" class="form-control" value="@(Model.Input == null ? "" : (Model.Input.GetType().GetProperty(f.PropName)?.GetValue(Model.Input) as string) ?? "")" />
                    }
                    else if (f.FieldKind == "multi")
                    {
                        <textarea name="Input.@f.PropName" class="form-control">@(Model.Input == null ? "" : (Model.Input.GetType().GetProperty(f.PropName)?.GetValue(Model.Input) as string) ?? "")</textarea>
                    }
                    else if (f.FieldKind == "numeric")
                    {
                        var val = Model.Input == null ? "" : (Model.Input.GetType().GetProperty(f.PropName)?.GetValue(Model.Input)?.ToString() ?? "");
                        <input type="number" name="Input.@f.PropName" step="any" class="form-control" value="@val" />
                    }
                    else if (f.FieldKind == "bool")
                    {
                        var isChecked = false;
                        if (Model.Input != null)
                        {
                            var prop = Model.Input.GetType().GetProperty(f.PropName);
                            if (prop != null)
                            {
                                var v = prop.GetValue(Model.Input);
                                if (v is bool b) isChecked = b;
                                if (v is bool?) isChecked = ((bool?)v) == true;
                            }
                        }
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="Input.@f.PropName" value="true" @(isChecked ? "checked" : "") />
                            <input type="hidden" name="Input.@f.PropName" value="false" />
                        </div>
                    }

                    @if (f.PropName == "SingleLine1") { <span asp-validation-for="Input.SingleLine1" class="text-danger"></span> }
                    else if (f.PropName == "SingleLine2") { <span asp-validation-for="Input.SingleLine2" class="text-danger"></span> }
                    else if (f.PropName == "SingleLine3") { <span asp-validation-for="Input.SingleLine3" class="text-danger"></span> }
                    else if (f.PropName == "MultiLine1") { <span asp-validation-for="Input.MultiLine1" class="text-danger"></span> }
                    else if (f.PropName == "MultiLine2") { <span asp-validation-for="Input.MultiLine2" class="text-danger"></span> }
                    else if (f.PropName == "MultiLine3") { <span asp-validation-for="Input.MultiLine3" class="text-danger"></span> }
                    else if (f.PropName == "NumericLine1") { <span asp-validation-for="Input.NumericLine1" class="text-danger"></span> }
                    else if (f.PropName == "NumericLine2") { <span asp-validation-for="Input.NumericLine2" class="text-danger"></span> }
                    else if (f.PropName == "NumericLine3") { <span asp-validation-for="Input.NumericLine3" class="text-danger"></span> }
                    else if (f.PropName == "BoolLine1") { <span asp-validation-for="Input.BoolLine1" class="text-danger"></span> }
                    else if (f.PropName == "BoolLine2") { <span asp-validation-for="Input.BoolLine2" class="text-danger"></span> }
                    else if (f.PropName == "BoolLine3") { <span asp-validation-for="Input.BoolLine3" class="text-danger"></span> }

                </div>
            }

            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-page="Index">Back to List</a>
</div>

@section Scripts {
    <script>
        (function () {
            try {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (el) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                        new bootstrap.Tooltip(el);
                    }
                });
            } catch (e) {}
        })();
    </script>
}
