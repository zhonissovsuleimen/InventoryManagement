@page
@model InventoryManagement.Pages.Items.DetailsModel

@{
    ViewData["Title"] = "Item Details";
    var likeCount = Model.Item.Likes?.Count ?? 0;
    var likedByMe = false;
    if (User?.Identity?.IsAuthenticated == true)
    {
        var uid = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        likedByMe = Model.Item.Likes?.Any(l => l.User != null && l.User.Id == uid) == true;
    }
}

<h1>Item Details</h1>

<div class="row">
    <div class="col-md-8">
        <dl class="row">
            <dt class="col-sm-3">Custom ID</dt>
            <dd class="col-sm-9">@Model.Item.CustomId</dd>

            <dt class="col-sm-3">Inventory</dt>
            <dd class="col-sm-9"><a asp-page="../Inventory/Details" asp-route-guid="@Model.Item.Inventory.Guid">@Model.Item.Inventory.Title</a></dd>

            <dt class="col-sm-3">Owner</dt>
            <dd class="col-sm-9">@Model.Item.Owner?.UserName (@Model.Item.Owner?.Email)</dd>

            <dt class="col-sm-3">Likes</dt>
            <dd class="col-sm-9">
                <div class="d-flex align-items-center gap-2" data-item-guid="@Model.Item.Guid">
                    @if (User?.Identity?.IsAuthenticated == true)
                    {
                        <form id="likeForm" method="post" class="d-none">
                            @Html.AntiForgeryToken()
                        </form>
                        <button id="likeBtn" type="button" class="btn btn-sm btn-outline-primary @(likedByMe ? "active" : "")" data-liked="@likedByMe.ToString().ToLower()" title="Like">
                            <span class="like-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                  <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                                </svg>
                            </span>
                        </button>
                    }
                    <span id="likeCount" class="fw-semibold">@likeCount</span>
                </div>
            </dd>

            @{
                var inv = Model.Item.Inventory;

                var fields = new List<(string PropName, string Kind, short? Position, string Title, string? Description, object? Value)>();

                void Add(string propName, string kind, InventoryManagement.Models.Inventory.CustomField? cf, object? value)
                {
                    if (cf == null || !cf.IsUsed) return;
                    var title = string.IsNullOrWhiteSpace(cf.Title) ? propName : cf.Title;
                    fields.Add((propName, kind, cf.Position, title, cf.Description, value));
                }

                Add("SingleLine1", "single", inv?.SingleLine1, Model.Item.SingleLine1);
                Add("SingleLine2", "single", inv?.SingleLine2, Model.Item.SingleLine2);
                Add("SingleLine3", "single", inv?.SingleLine3, Model.Item.SingleLine3);

                Add("MultiLine1", "multi", inv?.MultiLine1, Model.Item.MultiLine1);
                Add("MultiLine2", "multi", inv?.MultiLine2, Model.Item.MultiLine2);
                Add("MultiLine3", "multi", inv?.MultiLine3, Model.Item.MultiLine3);

                Add("NumericLine1", "numeric", inv?.NumericLine1, Model.Item.NumericLine1);
                Add("NumericLine2", "numeric", inv?.NumericLine2, Model.Item.NumericLine2);
                Add("NumericLine3", "numeric", inv?.NumericLine3, Model.Item.NumericLine3);

                Add("BoolLine1", "bool", inv?.BoolLine1, Model.Item.BoolLine1);
                Add("BoolLine2", "bool", inv?.BoolLine2, Model.Item.BoolLine2);
                Add("BoolLine3", "bool", inv?.BoolLine3, Model.Item.BoolLine3);

                fields = fields.OrderBy(f => f.Position ?? short.MaxValue).ToList();

            }

            @foreach (var f in fields)
            {
                <dt class="col-sm-3">
                    <span class="me-2">@f.Title</span>
                    @if (!string.IsNullOrWhiteSpace(f.Description))
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-muted" viewBox="0 0 16 16" style="cursor:help;" title="@f.Description" aria-hidden="true" focusable="false" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="false">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0" />
                        </svg>
                    }
                </dt>
                <dd class="col-sm-9">
                    @if (f.Kind == "single")
                    {
                        @f.Value
                    }
                    else if (f.Kind == "multi")
                    {
                        <div style="white-space:pre-wrap;">@f.Value</div>
                    }
                    else if (f.Kind == "numeric")
                    {
                        @f.Value
                    }
                    else if (f.Kind == "bool")
                    {
                        var b = (f.Value as bool?) ?? false;
                        @((b) ? "Yes" : "No")
                    }
                </dd>
            }
        </dl>

        <div class="d-flex gap-2 mt-3">
            <a asp-page="../Inventory/Details" asp-route-guid="@Model.Item.Inventory.Guid" class="btn btn-secondary btn-sm">Back to Inventory</a>
            @if (Model.CanEdit)
            {
                <a asp-page="./Edit" asp-route-guid="@Model.Item.Guid" class="btn btn-primary btn-sm">Edit</a>
            }
        </div>
    </div>
</div>

@section Scripts {
<script>
(function(){
  try {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) {
      if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        new bootstrap.Tooltip(el);
      }
    });
  } catch (e) {}
})();

(() => {
  const likeBtn = document.getElementById('likeBtn');
  const likeCount = document.getElementById('likeCount');
  const token = document.querySelector('#likeForm input[name="__RequestVerificationToken"]')?.value;
  const root = document.querySelector('[data-item-guid]');
  const guid = root?.getAttribute('data-item-guid');

  if (!likeBtn || !guid) return;

  likeBtn.addEventListener('click', async () => {
    const headers = {};
    if (token) {
      headers['RequestVerificationToken'] = token;
      headers['X-RequestVerificationToken'] = token;
    }
    const res = await fetch(`/api/items/${encodeURIComponent(guid)}/like`, {
      method: 'POST',
      headers,
      credentials: 'same-origin'
    });
    if (!res.ok) return;
    const data = await res.json();
    likeBtn.dataset.liked = data.liked ? 'true' : 'false';
    likeBtn.classList.toggle('active', !!data.liked);
    if (likeCount) likeCount.textContent = String(data.count ?? 0);
  });
})();
</script>
}
